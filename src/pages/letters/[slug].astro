---
import Layout from "../../layouts/Layout.astro";
import ThemeController from "../../components/ThemeController.astro";
import { getCollection, render } from "astro:content";
import { marked } from "marked";

export async function getStaticPaths() {
  const letters = await getCollection("letters");
  return letters.map((letter) => ({
    params: { slug: letter.id },
    props: { letter },
  }));
}

const { letter } = Astro.props;
const { Content } = await render(letter);

// Parse JP and ID markdown content from frontmatter
const bodyJpHtml = letter.data.body_jp
  ? await marked.parse(letter.data.body_jp)
  : "";
const bodyIdHtml = letter.data.body_id
  ? await marked.parse(letter.data.body_id)
  : "";
---

<Layout
  title={`${letter.data.title} | Vigarden`}
  description={letter.data.description}
>
  <ThemeController slot="header-right" />

  <main
    class="min-h-screen flex flex-col items-center justify-center py-24 sm:py-32 px-3 sm:px-4 relative z-10"
  >
    <article
      class="max-w-2xl w-full relative"
      transition:name={`letter-${letter.id}`}
    >
      <!-- Wax Seal -->
      <div class="flex justify-center -mb-8 relative z-30">
        <div
          class="w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-red-800 shadow-xl
                 border-4 border-red-900/50 flex items-center justify-center
                 text-red-200 font-heading font-bold text-base sm:text-lg tracking-wide"
        >
          CH
        </div>
      </div>

      <div class="airmail-border rounded-t-sm"></div>

      <!-- Paper Body -->
      <div
        class="letter-paper border-x border-gold/15 dark:border-white/5 p-5 sm:p-8 md:p-16 shadow-2xl relative"
      >
        <!-- Corner Ornaments -->
        <svg
          class="letter-ornament top-left"
          viewBox="0 0 100 100"
          fill="currentColor"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M5 5 Q5 50 50 50 Q5 50 5 95"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            opacity="0.6"></path>
          <path
            d="M5 5 Q50 5 50 50 Q50 5 95 5"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            opacity="0.6"></path>
          <circle cx="5" cy="5" r="3" opacity="0.4"></circle>
          <path
            d="M15 15 Q15 30 30 30"
            stroke="currentColor"
            stroke-width="1"
            fill="none"
            opacity="0.3"></path>
        </svg>
        <svg
          class="letter-ornament top-right"
          viewBox="0 0 100 100"
          fill="currentColor"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M5 5 Q5 50 50 50 Q5 50 5 95"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            opacity="0.6"></path>
          <path
            d="M5 5 Q50 5 50 50 Q50 5 95 5"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            opacity="0.6"></path>
          <circle cx="5" cy="5" r="3" opacity="0.4"></circle>
        </svg>
        <svg
          class="letter-ornament bottom-left"
          viewBox="0 0 100 100"
          fill="currentColor"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M5 5 Q5 50 50 50 Q5 50 5 95"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            opacity="0.6"></path>
          <path
            d="M5 5 Q50 5 50 50 Q50 5 95 5"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            opacity="0.6"></path>
          <circle cx="5" cy="5" r="3" opacity="0.4"></circle>
        </svg>
        <svg
          class="letter-ornament bottom-right"
          viewBox="0 0 100 100"
          fill="currentColor"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M5 5 Q5 50 50 50 Q5 50 5 95"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            opacity="0.6"></path>
          <path
            d="M5 5 Q50 5 50 50 Q50 5 95 5"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            opacity="0.6"></path>
          <circle cx="5" cy="5" r="3" opacity="0.4"></circle>
        </svg>

        <!-- Paper Texture (Removed for extreme performance) -->
        <div
          class="absolute inset-0 pointer-events-none opacity-[0.02] bg-[#8B7355]"
        >
        </div>

        <!-- Ruled Lines -->
        <div
          class="absolute inset-x-4 sm:inset-x-16 inset-y-0 pointer-events-none opacity-[0.06] dark:opacity-[0.03]"
          style="background-image: repeating-linear-gradient(transparent, transparent 31px, #8B7355 31px, #8B7355 32px); background-size: 100% 32px"
        >
        </div>

        <!-- Date / Location -->
        <div
          class="relative z-10 text-right mb-8 sm:mb-12 font-body text-xs sm:text-sm text-ink/50 dark:text-white/40 italic"
        >
          <span>{letter.data.date || "Unknown Date"}</span>
          <br />
          <span
            data-i18n="writtenAt"
            data-jp="執筆場所"
            data-id="Ditulis di"
            data-en="Written at">執筆場所</span
          >: {letter.data.location || "Leiden"}
        </div>

        <!-- Salutation -->
        <div class="relative z-10 mb-6 sm:mb-10">
          <p class="font-heading text-lg sm:text-xl text-ink dark:text-white">
            <span data-content-lang="en">Dearest {letter.data.recipient},</span>
            <span data-content-lang="jp" class="hidden"
              >{
                letter.data.recipient_jp
                  ? `${letter.data.recipient_jp}へ、`
                  : `Dearest ${letter.data.recipient},`
              }</span
            >
            <span data-content-lang="id" class="hidden"
              >{
                letter.data.recipient_id
                  ? `Kepada ${letter.data.recipient_id} tersayang,`
                  : `Dearest ${letter.data.recipient},`
              }</span
            >
          </p>
        </div>

        <!-- Content — EN (Markdown rendered) -->
        <div
          class="relative z-10 prose prose-sm sm:prose-lg max-w-none
                    prose-p:font-body prose-p:text-ink/85 dark:prose-p:text-white/70
                    prose-p:leading-[1.8] sm:prose-p:leading-[2] prose-p:mb-4 sm:prose-p:mb-6
                    prose-headings:font-heading
                    prose-a:text-accent
                    dark:prose-invert"
          data-content-lang="en"
        >
          <Content />
        </div>

        <!-- Content — JP -->
        {
          letter.data.body_jp && (
            <div
              class="relative z-10 prose prose-sm sm:prose-lg max-w-none
                    prose-p:font-body prose-p:text-ink/85 dark:prose-p:text-white/70
                    prose-p:leading-[1.8] sm:prose-p:leading-[2] prose-p:mb-4 sm:prose-p:mb-6
                    prose-headings:font-heading
                    prose-a:text-accent
                    prose-blockquote:border-l-4 prose-blockquote:border-gold/40 prose-blockquote:bg-ink/[0.03] dark:prose-blockquote:bg-white/[0.04] prose-blockquote:py-3 prose-blockquote:px-5 prose-blockquote:rounded-r-lg prose-blockquote:italic prose-blockquote:my-6
                    prose-strong:font-semibold prose-strong:text-ink dark:prose-strong:text-white/90
                    prose-li:text-ink/80 dark:prose-li:text-white/65 prose-li:leading-[1.8]
                    prose-hr:border-ink/10 dark:prose-hr:border-white/10 prose-hr:my-6
                    dark:prose-invert hidden"
              data-content-lang="jp"
              set:html={bodyJpHtml}
            />
          )
        }

        <!-- Content — ID -->
        {
          letter.data.body_id && (
            <div
              class="relative z-10 prose prose-sm sm:prose-lg max-w-none
                    prose-p:font-body prose-p:text-ink/85 dark:prose-p:text-white/70
                    prose-p:leading-[1.8] sm:prose-p:leading-[2] prose-p:mb-4 sm:prose-p:mb-6
                    prose-headings:font-heading
                    prose-a:text-accent
                    prose-blockquote:border-l-4 prose-blockquote:border-gold/40 prose-blockquote:bg-ink/[0.03] dark:prose-blockquote:bg-white/[0.04] prose-blockquote:py-3 prose-blockquote:px-5 prose-blockquote:rounded-r-lg prose-blockquote:italic prose-blockquote:my-6
                    prose-strong:font-semibold prose-strong:text-ink dark:prose-strong:text-white/90
                    prose-li:text-ink/80 dark:prose-li:text-white/65 prose-li:leading-[1.8]
                    prose-hr:border-ink/10 dark:prose-hr:border-white/10 prose-hr:my-6
                    dark:prose-invert hidden"
              data-content-lang="id"
              set:html={bodyIdHtml}
            />
          )
        }

        <!-- Golden Divider -->
        <div
          class="relative z-10 mt-10 sm:mt-16 mb-6 flex items-center justify-center gap-3"
        >
          <div
            class="h-[1px] flex-1 bg-gradient-to-r from-transparent via-gold/30 to-transparent"
          >
          </div>
          <span class="text-gold/40 text-xs">✦</span>
          <div
            class="h-[1px] flex-1 bg-gradient-to-r from-transparent via-gold/30 to-transparent"
          >
          </div>
        </div>

        <!-- Signature -->
        <div class="relative z-10 mt-4 text-right space-y-3">
          <p
            class="font-body text-xs sm:text-sm italic text-ink/55 dark:text-white/45"
            data-i18n="sincerely"
            data-jp="敬具"
            data-id="Hormat kami"
            data-en="Sincerely"
          >
            敬具,
          </p>
          <div
            class="font-heading text-2xl sm:text-3xl text-accent dark:text-gold italic"
          >
            {letter.data.sender}
          </div>
          <p
            class="text-[8px] sm:text-[9px] uppercase tracking-[0.3em] text-ink/30 dark:text-white/25 font-sans"
          >
            Auto Memories Doll Service
          </p>
        </div>

        <!-- Episode -->
        {
          letter.data.episode && (
            <div class="relative z-10 mt-8 sm:mt-12 pt-4 sm:pt-6 border-t border-dashed border-ink/10 dark:border-white/10">
              <p class="text-[9px] sm:text-[10px] text-ink/40 dark:text-white/30 uppercase tracking-widest font-sans">
                Episode: {letter.data.episode}
              </p>
            </div>
          )
        }

        <!-- Watermark -->
        <div class="letter-watermark">Auto Memories Doll Service</div>
      </div>

      <div class="airmail-border rounded-b-sm"></div>

      <!-- Back Button -->
      <div class="mt-12 sm:mt-16 text-center pb-8 sm:pb-0">
        <a
          href="/letters/"
          class="inline-flex items-center justify-center gap-3 px-6 sm:px-8 py-3.5 sm:py-4 rounded-full
                 bg-white/50 dark:bg-black/40 border border-gold/40 shadow-md backdrop-blur-sm
                 hover:bg-gold hover:text-white dark:hover:bg-gold dark:hover:text-ink
                 text-xs sm:text-sm font-bold uppercase tracking-[0.2em] text-ink dark:text-gold
                 transition-all duration-300 group focus:outline-none focus:ring-2 focus:ring-gold/50"
          data-i18n="returnToCollection"
          data-jp="← コレクションに戻る"
          data-id="← Kembali ke Koleksi"
          data-en="← Return to Collection"
        >
          <svg
            class="w-4 h-4 sm:w-5 sm:h-5 transform group-hover:-translate-x-1 transition-transform duration-300"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          <span
            data-i18n="returnToCollection"
            data-jp="コレクションに戻る"
            data-id="Kembali ke Koleksi"
            data-en="Return to Collection"
          >
            Return to Collection
          </span>
        </a>
      </div>
    </article>
  </main>
</Layout>
