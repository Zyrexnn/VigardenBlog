---
import Layout from "../../../layouts/Layout.astro";
import ThemeController from "../../../components/ThemeController.astro";
import { getCollection, render } from "astro:content";
import { ui, defaultLang } from "../../../i18n/ui";
import { useTranslations } from "../../../i18n/utils";

export async function getStaticPaths() {
  return [
    { params: { locale: undefined } }, // id (default)
    { params: { locale: "en" } },
    { params: { locale: "ja" } },
  ];
}

const { locale } = Astro.params;
const currentLang = (locale as keyof typeof ui) || defaultLang;
const t = useTranslations(currentLang);

// Content loading: fetch all versions to support instant client-side switching
const allStories = await getCollection("stories");
const idEntry = allStories.find((s) => s.data.lang === "id");
const enEntry = allStories.find((s) => s.data.lang === "en");
const jaEntry = allStories.find((s) => s.data.lang === "ja");

const [renderedId, renderedEn, renderedJa] = await Promise.all([
  idEntry ? render(idEntry) : Promise.resolve(null),
  enEntry ? render(enEntry) : Promise.resolve(null),
  jaEntry ? render(jaEntry) : Promise.resolve(null),
]);

const IdContent = renderedId?.Content;
const EnContent = renderedEn?.Content;
const JaContent = renderedJa?.Content;

const storyEntry = idEntry || allStories[0]; // Fallback for layout props
---

<Layout
  title={storyEntry?.data.title || t("story.title")}
  description={storyEntry?.data.description || t("meta.description")}
  image="/images/violet-dark.gif"
>
  <ThemeController slot="header-right" />

  <!-- Hero Section (Matches Letters Page) -->
  <div class="bg-paper dark:bg-dark-bg relative transition-colors duration-300">
    <section
      class="relative h-[40vh] sm:h-[50vh] min-h-[300px] w-full flex flex-col items-center justify-center text-center overflow-hidden"
    >
      <div class="absolute inset-0 z-0">
        <img
          src="/images/violet-dark.gif"
          alt=""
          id="hero-bg"
          class="w-full h-full object-cover opacity-20 dark:opacity-30 blur-[2px] scale-105 transition-opacity duration-700"
        />
        <div
          class="absolute inset-0 bg-gradient-to-b from-ink/10 via-transparent to-paper dark:to-dark-bg"
        >
        </div>
      </div>

      <div class="relative z-10 space-y-4 px-4 sm:px-6 animate-fade-in-up">
        <h1
          class="text-4xl sm:text-6xl md:text-8xl font-heading text-ink dark:text-white drop-shadow-2xl tracking-tighter"
          data-i18n="story.title"
        >
          {t("story.title")}
        </h1>
        <p
          class="text-ink/60 dark:text-white/60 font-body text-xs sm:text-sm tracking-[0.2em] sm:tracking-[0.3em] uppercase italic"
          data-i18n="story.subtitle"
        >
          {t("story.subtitle")}
        </p>
      </div>

      <div
        class="absolute bottom-0 left-0 w-full overflow-hidden leading-[0] z-20 pointer-events-none"
      >
        <svg
          class="block w-full h-10 sm:h-12 md:h-20"
          viewBox="0 24 150 28"
          preserveAspectRatio="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <defs
            ><path
              id="letters-wave"
              d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"
            ></path></defs
          >
          <use
            href="#letters-wave"
            x="48"
            y="7"
            fill="currentColor"
            class="text-paper dark:text-dark-bg transition-colors duration-300"
          ></use>
        </svg>
      </div>
    </section>

    <!-- Content Section -->
    <main class="max-w-4xl mx-auto px-4 py-12 md:py-20 relative z-10">
      <!-- Warnings -->
      <div
        class="bg-red-900/5 border border-red-900/10 rounded-lg p-6 mb-12 text-center max-w-2xl mx-auto"
      >
        <p
          class="text-xs font-bold text-red-700 dark:text-red-400 uppercase tracking-widest mb-1"
          data-i18n="story.spoiler"
        >
          {t("story.spoiler")}
        </p>
        <p
          class="text-[10px] text-ink/50 dark:text-white/50 italic"
          data-i18n="story.trigger"
        >
          {t("story.trigger")}
        </p>
      </div>

      <!-- Multi-Language Story Content Containers -->
      <article class="prose dark:prose-invert mx-auto story-content">
        <div
          data-content-lang="id"
          class={currentLang === "id" ? "" : "hidden"}
        >
          {IdContent && <IdContent />}
        </div>
        <div
          data-content-lang="en"
          class={currentLang === "en" ? "" : "hidden"}
        >
          {EnContent && <EnContent />}
        </div>
        <div
          data-content-lang="jp"
          class={currentLang === "ja" ? "" : "hidden"}
        >
          {JaContent && <JaContent />}
        </div>
      </article>

      <!-- Call to Action -->
      <div
        class="mt-20 pt-10 border-t border-ink/10 dark:border-white/10 text-center"
      >
        <h3
          class="text-2xl font-heading mb-4 text-accent dark:text-gold"
          data-i18n="story.cta.title"
        >
          {t("story.cta.title")}
        </h3>
        <p
          class="mb-8 font-body text-ink/80 dark:text-white/80"
          data-i18n="story.cta.text"
        >
          {t("story.cta.text")}
        </p>
        <a
          href="/letters/write"
          class="inline-block px-8 py-3 bg-accent dark:bg-gold text-white dark:text-black font-bold uppercase tracking-widest rounded hover:scale-105 transition-transform duration-300 shadow-lg"
          data-i18n="story.cta.button"
        >
          {t("story.cta.button")}
        </a>
      </div>
    </main>
  </div>
</Layout>

<style is:global>
  /* Custom Story Styling */
  .story-content h3 {
    @apply font-heading text-3xl text-center mb-8 text-accent dark:text-gold mt-16;
  }

  .story-content p {
    @apply mb-6 leading-relaxed text-lg text-ink/80 dark:text-white/80;
  }

  /* Drop Cap for Introduction */
  .story-section.introduction p:first-of-type::first-letter {
    @apply text-5xl float-left mr-3 mt-[-6px] font-heading text-accent dark:text-gold;
  }

  /* Accordion / Details Styling */
  details.story-arc {
    @apply mb-8 bg-paper dark:bg-white/5 border border-ink/10 dark:border-white/10 rounded-lg overflow-hidden transition-all duration-300;
  }

  details.story-arc[open] {
    @apply bg-white dark:bg-black/20 shadow-lg border-accent/20 dark:border-gold/20;
  }

  details.story-arc summary {
    @apply cursor-pointer p-6 font-heading text-xl font-bold flex items-center justify-between select-none outline-none text-ink dark:text-white;
    list-style: none; /* Hide default triangle */
  }

  details.story-arc summary::-webkit-details-marker {
    display: none;
  }

  details.story-arc summary::after {
    content: "+";
    @apply text-2xl font-light text-accent dark:text-gold transition-transform duration-300;
  }

  details.story-arc[open] summary::after {
    transform: rotate(45deg);
  }

  details.story-arc .content {
    @apply px-6 pb-6 pt-2;
    animation: slide-down 0.3s ease-out forwards;
  }

  /* Animated Quotes */
  .quote-container {
    @apply my-16 text-center relative py-12 px-6;
  }

  .quote-container::before {
    content: "â€œ";
    @apply absolute top-0 left-1/2 -translate-x-1/2 text-8xl font-heading text-accent/10 dark:text-gold/10 font-bold;
  }

  .quote-container blockquote {
    @apply font-heading text-2xl md:text-3xl italic text-ink dark:text-white relative z-10;
  }

  .quote-container cite {
    @apply block mt-6 text-sm font-bold uppercase tracking-widest text-accent dark:text-gold not-italic opacity-0 translate-y-4 transition-all duration-700 delay-300;
  }

  /* Animation observer class */
  .quote-container.visible cite {
    @apply opacity-100 translate-y-0;
  }

  .quote-container.visible blockquote {
    animation: fade-scale-in 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
  }

  @keyframes fade-scale-in {
    from {
      opacity: 0;
      transform: scale(0.95);
      filter: blur(4px);
    }
    to {
      opacity: 1;
      transform: scale(1);
      filter: blur(0);
    }
  }

  @keyframes slide-down {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fade-in-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in-up {
    animation: fade-in-up 1s ease-out forwards;
  }

  .delay-200 {
    animation-delay: 200ms;
  }
</style>

<script>
  // Intersection Observer for Quotes
  const observerOptions = {
    root: null,
    rootMargin: "0px",
    threshold: 0.3,
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.add("visible");
      }
    });
  }, observerOptions);

  document.addEventListener("astro:page-load", () => {
    document.querySelectorAll(".quote-container").forEach((el) => {
      observer.observe(el);
    });
  });
</script>
