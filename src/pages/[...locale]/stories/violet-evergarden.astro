---
import Layout from "../../../layouts/Layout.astro";
import ThemeController from "../../../components/ThemeController.astro";
import { getCollection, render } from "astro:content";
import { ui, defaultLang } from "../../../i18n/ui";
import { useTranslations } from "../../../i18n/utils";

export async function getStaticPaths() {
  return [
    { params: { locale: undefined } },
    { params: { locale: "en" } },
    { params: { locale: "ja" } },
  ];
}

const { locale } = Astro.params;
const currentLang = (locale as keyof typeof ui) || defaultLang;
const t = useTranslations(currentLang);

const allStories = await getCollection("stories");
const idEntry = allStories.find((s) => s.data.lang === "id");
const enEntry = allStories.find((s) => s.data.lang === "en");
const jaEntry = allStories.find((s) => s.data.lang === "ja");

const [renderedId, renderedEn, renderedJa] = await Promise.all([
  idEntry ? render(idEntry) : Promise.resolve(null),
  enEntry ? render(enEntry) : Promise.resolve(null),
  jaEntry ? render(jaEntry) : Promise.resolve(null),
]);

const IdContent = renderedId?.Content;
const EnContent = renderedEn?.Content;
const JaContent = renderedJa?.Content;

const storyEntry = idEntry || allStories[0];
---

<Layout
  title={storyEntry?.data.title || t("story.title")}
  description={storyEntry?.data.description || t("meta.description")}
  image="/images/violet-dark.gif"
>
  <ThemeController slot="header-right" />

  <!-- The dynamic background that changes on scroll -->
  <div
    id="cinematic-bg-container"
    class="fixed inset-0 z-0 bg-paper dark:bg-dark-bg transition-colors duration-1000 ease-in-out pointer-events-none"
  >
  </div>

  <div class="relative z-10 w-full overflow-x-hidden">
    <!-- Cinematic Hero -->
    <section
      class="min-h-screen flex flex-col items-center justify-center relative"
    >
      <!-- Faint overlay GIF -->
      <img
        src="/images/violet-light.gif"
        alt=""
        class="absolute inset-0 w-full h-full object-cover opacity-10 dark:opacity-20 blur-sm pointer-events-none mix-blend-overlay"
      />

      <div class="relative z-10 text-center px-4 w-full pt-20">
        <h1
          class="text-6xl sm:text-8xl md:text-9xl lg:text-[10rem] font-heading text-ink dark:text-white drop-shadow-xl tracking-wide hero-title-reveal"
          data-i18n="story.title"
        >
          {t("story.title")}
        </h1>
        <p
          class="mt-8 text-ink/50 dark:text-white/50 font-body text-xs sm:text-sm md:text-lg tracking-[0.4em] uppercase italic hero-subtitle-reveal"
          data-i18n="story.subtitle"
        >
          {t("story.subtitle")}
        </p>

        <!-- Warning subtle hint -->
        <p
          class="mt-16 text-[10px] text-red-800 dark:text-red-400/50 uppercase tracking-[0.3em] hero-subtitle-reveal opacity-50"
        >
          <span data-i18n="story.spoiler">{t("story.spoiler")}</span> - <span
            data-i18n="story.trigger">{t("story.trigger")}</span
          >
        </p>
      </div>

      <!-- The Guiding Line -->
      <div
        class="absolute bottom-0 left-1/2 -translate-x-1/2 h-32 w-px bg-gradient-to-b from-transparent via-ink/30 dark:via-white/30 to-transparent overflow-hidden"
      >
        <div
          class="absolute top-0 left-0 w-full h-1/2 bg-accent dark:bg-gold animate-scroll-indicator"
        >
        </div>
      </div>
    </section>

    <!-- The Editorial Story Flow -->
    <main class="cinematic-story-wrapper pt-32">
      <article class="max-w-[1400px] mx-auto px-6 sm:px-12 lg:px-24">
        <!-- Render specific lang content based on toggle -->
        <div
          data-content-lang="id"
          class={currentLang === "id" ? "" : "hidden"}
        >
          {IdContent && <IdContent />}
        </div>
        <div
          data-content-lang="en"
          class={currentLang === "en" ? "" : "hidden"}
        >
          {EnContent && <EnContent />}
        </div>
        <div
          data-content-lang="ja"
          class={currentLang === "ja" ? "" : "hidden"}
        >
          {JaContent && <JaContent />}
        </div>
      </article>
    </main>

    <!-- Cinematic Footer / CTA -->
    <section
      class="min-h-[60vh] flex flex-col items-center justify-center text-center px-4 mb-20 relative fade-in-up"
    >
      <div class="relative z-10 flex flex-col items-center">
        <!-- Animated CSS Wax Seal instead of the broken image -->
        <div
          class="wax-seal-btn flex items-center justify-center mx-auto mb-10 w-24 h-24 sm:w-28 sm:h-28 opacity-90 cursor-default hover:scale-100 shadow-2xl border-[#8b0000]"
        >
          <span class="text-4xl sm:text-5xl drop-shadow-lg opacity-80">ðŸ’Œ</span>
        </div>
        <h3
          class="text-3xl sm:text-5xl font-heading mb-10 text-ink dark:text-white"
          data-i18n="story.cta.title"
        >
          {t("story.cta.title")}
        </h3>
        <p
          class="mb-12 font-body text-ink/70 dark:text-white/70 max-w-xl mx-auto text-lg"
          data-i18n="story.cta.text"
        >
          {t("story.cta.text")}
        </p>
        <a
          href="/letters/write"
          class="inline-block border border-accent dark:border-gold px-12 py-5 font-body tracking-[0.3em] uppercase text-xs sm:text-sm hover:bg-accent hover:text-white dark:hover:bg-gold dark:hover:text-black transition-all duration-500"
        >
          <span data-i18n="story.cta.button">{t("story.cta.button")}</span>
        </a>
      </div>
    </section>
  </div>
</Layout>

<style is:global>
  /* Cinematic Story Styles */
  .cinematic-story-wrapper {
    padding-bottom: 10vh;
  }

  /* Split Layout Container */
  .story-arc-cinematic {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-bottom: 25vh; /* Massive spacing for dramatic pacing */
    position: relative;
  }

  /* Desktop Sticky Logic */
  @media (min-width: 1024px) {
    .story-arc-cinematic {
      flex-direction: row;
      gap: 10rem;
      margin-bottom: 40vh;
    }
    .arc-sticky-panel {
      flex: 0 0 35%;
      position: sticky;
      top: 35vh;
      height: fit-content;
      transform: translateY(30px);
      opacity: 0.3;
      transition: all 1s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .arc-content {
      flex: 1;
      padding-top: 35vh;
    }
    /* When user scrolls deeply into the arc, the sticky panel pops into full focus */
    .story-arc-cinematic.is-active .arc-sticky-panel {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Typography Enhancements */
  .arc-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: 1.5rem;
    filter: drop-shadow(0 0 20px rgba(var(--gold-rgb), 0.3));
    opacity: 0.8;
  }

  /* Reveal Animations */
  .fade-in-up {
    opacity: 0;
    transform: translateY(50px);
    transition: all 1.2s cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  .fade-in-up.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .hero-title-reveal {
    opacity: 0;
    animation: slowFadeUp 2.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
  }

  .hero-subtitle-reveal {
    opacity: 0;
    animation: slowFadeUp 2.5s cubic-bezier(0.2, 0.8, 0.2, 1) 1s forwards;
  }

  @keyframes slowFadeUp {
    0% {
      opacity: 0;
      transform: translateY(40px) scale(0.98);
      filter: blur(4px);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
      filter: blur(0);
    }
  }

  @keyframes scrollIndicator {
    0% {
      transform: translateY(-100%);
      opacity: 0;
    }
    50% {
      opacity: 1;
    }
    100% {
      transform: translateY(200%);
      opacity: 0;
    }
  }

  .animate-scroll-indicator {
    animation: scrollIndicator 2.5s infinite cubic-bezier(0.65, 0, 0.35, 1);
  }
</style>

<script>
  document.addEventListener("astro:page-load", () => {
    // 1. Text Reveal Observer
    const revealElements = document.querySelectorAll(".fade-in-up");
    const revealObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("is-visible");
          }
        });
      },
      {
        threshold: 0.15,
        rootMargin: "0px 0px -50px 0px",
      },
    );
    revealElements.forEach((el) => revealObserver.observe(el));

    // 2. Cinematic Background / Sticky Theme Shift Observer
    const arcBlocks = document.querySelectorAll(".story-arc-cinematic");
    const bgContainer = document.getElementById("cinematic-bg-container");

    // Default background classes
    const baseBgClasses =
      "fixed inset-0 z-0 transition-colors duration-1000 ease-in-out pointer-events-none";

    const themeObserver = new IntersectionObserver(
      (entries) => {
        // Find the currently active intersecting block
        let activeEntry = entries.find((e) => e.isIntersecting);

        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("is-active");
          } else {
            entry.target.classList.remove("is-active");
          }
        });

        if (activeEntry && bgContainer) {
          const theme = activeEntry.target.getAttribute("data-color-theme");
          // Reset and apply specific background tint based on the emotional arc
          bgContainer.className = baseBgClasses;

          if (theme === "war") {
            bgContainer.classList.add("bg-red-950/20", "dark:bg-red-900/10");
          } else if (theme === "doll") {
            bgContainer.classList.add("bg-blue-900/10", "dark:bg-blue-900/10");
          } else if (theme === "forgiveness") {
            bgContainer.classList.add(
              "bg-emerald-900/10",
              "dark:bg-emerald-900/5",
            );
          } else if (theme === "reunion") {
            bgContainer.classList.add(
              "bg-amber-100/50",
              "dark:bg-amber-900/10",
            );
          } else {
            bgContainer.classList.add("bg-paper", "dark:bg-dark-bg");
          }
        } else if (
          !activeEntry &&
          bgContainer &&
          window.scrollY < window.innerHeight
        ) {
          // Reset to default if we scroll back to hero
          bgContainer.className = baseBgClasses + " bg-paper dark:bg-dark-bg";
        }
      },
      {
        // Trigger when the arc crosses the middle of the screen
        threshold: 0,
        rootMargin: "-40% 0px -40% 0px",
      },
    );

    arcBlocks.forEach((arc) => themeObserver.observe(arc));
  });
</script>
