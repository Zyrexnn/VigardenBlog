---
/**
 * VioletWidget.astro
 * Interactive floating character with dragging and speech bubbles.
 * Optimized: no animejs dependency, uses CSS transitions instead.
 */
---

<div
  id="violet-widget"
  class="fixed bottom-10 left-10 z-[200] select-none group"
  style="touch-action: none;"
>
  <!-- Speech Bubble -->
  <div
    id="violet-speech"
    class="absolute -top-24 left-1/2 -translate-x-1/2 bg-[#1e1a1b]/90 dark:bg-[#161213]/90 text-white py-3 px-6 rounded-2xl shadow-2xl border border-white/10 text-xs font-sans whitespace-nowrap opacity-0 pointer-events-none"
    style="transition: opacity 0.4s ease, transform 0.4s ease; transform: translateX(-50%) translateY(10px);"
  >
    What are you doing?
    <div
      class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-[#1e1a1b]/90 dark:bg-[#161213]/90 rotate-45 border-r border-b border-white/10"
    >
    </div>
  </div>

  <!-- Interactive Menu -->
  <div
    id="violet-menu"
    class="absolute -top-14 left-1/2 -translate-x-1/2 flex flex-row gap-2 opacity-0 pointer-events-none transition-all duration-300 scale-90 origin-bottom"
  >
    <a
      href="/"
      class="w-10 h-10 rounded-full bg-paper dark:bg-dark-bg border border-accent/20 dark:border-gold/30 flex items-center justify-center text-ink dark:text-white hover:bg-accent hover:text-white dark:hover:bg-gold dark:hover:text-black transition-all shadow-xl text-lg hover:-translate-y-1"
      title="Home">üè†</a
    >
    <a
      href="/letters/write"
      class="w-10 h-10 rounded-full bg-paper dark:bg-dark-bg border border-accent/20 dark:border-gold/30 flex items-center justify-center text-ink dark:text-white hover:bg-accent hover:text-white dark:hover:bg-gold dark:hover:text-black transition-all shadow-xl text-lg hover:-translate-y-1"
      title="Write Letter">‚úçÔ∏è</a
    >
    <button
      id="close-widget"
      class="w-10 h-10 rounded-full bg-paper dark:bg-dark-bg border border-accent/20 dark:border-gold/30 flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition-all shadow-xl text-lg hover:-translate-y-1"
      title="Close">√ó</button
    >
  </div>

  <!-- Character -->
  <div
    class="relative w-20 h-20 sm:w-28 sm:h-28 md:w-[120px] md:h-[120px] cursor-grab active:cursor-grabbing"
  >
    <img
      src="/images/charviolet-removebg-preview.png"
      alt="Violet Evergarden"
      class="w-full h-full object-contain relative z-10 pointer-events-none drop-shadow-[0_8px_8px_rgba(0,0,0,0.25)]"
      loading="lazy"
      width="120"
      height="120"
    />
  </div>
</div>

<script>
  function initWidget() {
    const widget = document.getElementById("violet-widget");
    const speech = document.getElementById("violet-speech");
    const closeBtn = document.getElementById("close-widget");
    if (!widget) return;

    let isDragging = false;
    let startX: number, startY: number;
    let initialX: number, initialY: number;

    const onMove = (e: MouseEvent | TouchEvent) => {
      if (!isDragging) return;
      const pos = e instanceof MouseEvent ? e : e.touches[0];
      const dx = pos.clientX - startX;
      const dy = pos.clientY - startY;
      const padding = 20;
      const maxX = window.innerWidth - widget.offsetWidth - padding;
      const maxY = window.innerHeight - widget.offsetHeight - padding;
      widget.style.left = `${Math.max(padding, Math.min(initialX + dx, maxX))}px`;
      widget.style.top = `${Math.max(padding, Math.min(initialY + dy, maxY))}px`;
    };

    const onEnd = () => {
      isDragging = false;
      widget.style.transition = "transform 0.3s ease";
      window.removeEventListener("mousemove", onMove);
      window.removeEventListener("mouseup", onEnd);
      window.removeEventListener("touchmove", onMove);
      window.removeEventListener("touchend", onEnd);
    };

    const onStart = (e: MouseEvent | TouchEvent) => {
      const target = e.target as HTMLElement;
      if (
        target.tagName === "A" ||
        target.tagName === "BUTTON" ||
        target.closest("a, button")
      )
        return;
      isDragging = true;
      const pos = e instanceof MouseEvent ? e : e.touches[0];
      startX = pos.clientX;
      startY = pos.clientY;
      const rect = widget.getBoundingClientRect();
      initialX = rect.left;
      initialY = rect.top;
      widget.style.transition = "none";
      window.addEventListener("mousemove", onMove);
      window.addEventListener("mouseup", onEnd);
      window.addEventListener("touchmove", onMove, { passive: false });
      window.addEventListener("touchend", onEnd);
    };

    widget.addEventListener("mousedown", onStart);
    widget.addEventListener("touchstart", onStart, { passive: false });

    // Speech bubbles ‚Äî pure CSS transitions, no animejs
    const messages = [
      "What are you doing? ‚úâÔ∏è",
      "Sincerely, Violet Evergarden.",
      "It's a beautiful day, isn't it?",
      "Delivering feelings to those in need.",
      "May your day be full of joy.",
    ];

    let speechTimeout: ReturnType<typeof setTimeout>;
    function showSpeech() {
      if (!speech) return;
      clearTimeout(speechTimeout);
      speech.textContent =
        messages[Math.floor(Math.random() * messages.length)];
      speech.style.opacity = "1";
      speech.style.transform = "translateX(-50%) translateY(0)";
      speechTimeout = setTimeout(() => {
        speech.style.opacity = "0";
        speech.style.transform = "translateX(-50%) translateY(-8px)";
      }, 4000);
    }

    let menuOpen = false;
    widget.addEventListener("click", (e) => {
      if (isDragging) return;
      if ((e.target as HTMLElement).closest("a, button")) return;

      const menu = document.getElementById("violet-menu");
      if (menu) {
        menuOpen = !menuOpen;
        if (menuOpen) {
          menu.classList.remove("opacity-0", "pointer-events-none", "scale-90");
          menu.classList.add("opacity-100", "pointer-events-auto", "scale-100");
        } else {
          menu.classList.add("opacity-0", "pointer-events-none", "scale-90");
          menu.classList.remove(
            "opacity-100",
            "pointer-events-auto",
            "scale-100",
          );
        }
      }
      showSpeech();
    });

    if (closeBtn) {
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        widget.style.opacity = "0";
        widget.style.transform = "scale(0.8)";
        setTimeout(() => (widget.style.display = "none"), 300);
      };
    }
  }

  initWidget();
  document.addEventListener("astro:after-swap", initWidget);
</script>
