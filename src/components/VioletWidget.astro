---
/**
 * VioletWidget.astro
 * Interactive floating character with dragging, speech bubbles,
 * and eye-tracking. Refined for Mizuki aesthetic.
 */
---

<div
  id="violet-widget"
  class="fixed bottom-10 left-10 z-[200] select-none transition-all duration-300 group"
  style="touch-action: none; transition-property: transform, opacity;"
>
  <!-- Speech Bubble (Mizuki Glass Style) -->
  <div
    id="violet-speech"
    class="absolute -top-24 left-1/2 -translate-x-1/2 bg-[#1e1a1b]/90 dark:bg-[#161213]/90 text-white py-3 px-6 rounded-2xl shadow-2xl border border-white/10 text-xs font-sans whitespace-nowrap opacity-0 transition-all duration-300 pointer-events-none backdrop-blur-md"
  >
    What are you doing?
    <div
      class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-[#1e1a1b]/90 dark:bg-[#161213]/90 rotate-45 border-r border-b border-white/10"
    >
    </div>
  </div>

  <!-- Interactive Menu (Floating Pill Style) -->
  <div
    id="violet-menu"
    class="absolute -right-14 top-1/2 -translate-y-1/2 flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300 translate-x-4 group-hover:translate-x-0"
  >
    <a
      href="/"
      class="w-10 h-10 rounded-xl bg-[#1e1a1b]/80 backdrop-blur-xl border border-white/10 flex items-center justify-center text-white hover:bg-gold transition-all shadow-lg text-lg"
      >ğŸ </a
    >
    <a
      href="/blog/"
      class="w-10 h-10 rounded-xl bg-[#1e1a1b]/80 backdrop-blur-xl border border-white/10 flex items-center justify-center text-white hover:bg- gold transition-all shadow-lg text-lg"
      >ğŸ“œ</a
    >
    <button
      id="close-widget"
      class="w-10 h-10 rounded-xl bg-red-500/20 backdrop-blur-xl border border-red-500/20 flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition-all shadow-lg text-lg"
      >Ã—</button
    >
  </div>

  <!-- Character Box -->
  <div class="relative w-[160px] h-[160px] cursor-grab active:cursor-grabbing">
    <!-- Iris (Eye Tracking) -->
    <div class="absolute inset-0 z-0 pointer-events-none">
      <div
        id="widget-iris"
        class="absolute rounded-full"
        style="
          width: 14px; height: 14px; 
          top: 34.6%; left: 63.8%; 
          background: radial-gradient(circle at 40% 40%, #5de0e6 0%, #0077cc 60%, #003366 100%);
          box-shadow: 0 0 8px rgba(0,119,204,0.5), inset 0 0 4px rgba(0,0,0,0.4);
          transform: translate(-50%, -50%);
        "
      >
        <!-- Pupil -->
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="w-4 h-4 bg-black/80 rounded-full"></div>
        </div>
        <!-- Eye Highlight -->
        <div class="absolute w-2 h-2 bg-white/60 rounded-full top-0.5 right-1">
        </div>
      </div>
    </div>

    <!-- Face Image (Ensure it has eye holes!) -->
    <img
      src="/images/charviolet-removebg-preview.webp"
      alt="Violet Evergarden"
      class="w-full h-full object-contain relative z-10 pointer-events-none drop-shadow-[0_10px_10px_rgba(0,0,0,0.5)]"
      loading="eager"
    />

    <!-- Eyelid (Blink) -->
    <div
      id="widget-eyelid"
      class="absolute bg-[#e8c0a8] dark:bg-[#b08870] z-20 origin-top pointer-events-none"
      style="
        width: 32px; height: 20px; 
        top: 32%; left: 60%; 
        border-radius: 50%;
        transform: scaleY(0);
      "
    >
    </div>
  </div>
</div>

<script>
  import { animate } from "animejs";

  function initWidget() {
    const widget = document.getElementById("violet-widget");
    const speech = document.getElementById("violet-speech");
    const iris = document.getElementById("widget-iris");
    const eyelid = document.getElementById("widget-eyelid");
    const closeBtn = document.getElementById("close-widget");

    if (!widget) return;

    // --- DRAGGING LOGIC ---
    let isDragging = false;
    let startX: number, startY: number;
    let initialX: number, initialY: number;

    const onStart = (e: MouseEvent | TouchEvent) => {
      if (
        (e.target as HTMLElement).tagName === "A" ||
        (e.target as HTMLElement).tagName === "BUTTON"
      )
        return;
      isDragging = true;
      const pos = e instanceof MouseEvent ? e : e.touches[0];
      startX = pos.clientX;
      startY = pos.clientY;
      const rect = widget.getBoundingClientRect();
      initialX = rect.left;
      initialY = rect.top;
      widget.style.transition = "none";
    };

    const onMove = (e: MouseEvent | TouchEvent) => {
      if (!isDragging) return;
      const pos = e instanceof MouseEvent ? e : e.touches[0];
      const dx = pos.clientX - startX;
      const dy = pos.clientY - startY;

      const nextX = initialX + dx;
      const nextY = initialY + dy;

      // Keep within viewport bounds
      const padding = 20;
      const maxX = window.innerWidth - widget.offsetWidth - padding;
      const maxY = window.innerHeight - widget.offsetHeight - padding;

      widget.style.left = `${Math.max(padding, Math.min(nextX, maxX))}px`;
      widget.style.top = `${Math.max(padding, Math.min(nextY, maxY))}px`;
      widget.style.bottom = "auto";
    };

    const onEnd = () => {
      isDragging = false;
      widget.style.transition = "all 0.3s cubic-bezier(0.4, 0, 0.2, 1)";
    };

    widget.addEventListener("mousedown", onStart);
    window.addEventListener("mousemove", onMove);
    window.addEventListener("mouseup", onEnd);

    widget.addEventListener("touchstart", onStart, { passive: false });
    window.addEventListener("touchmove", onMove, { passive: false });
    window.addEventListener("touchend", onEnd);

    // --- RANDOM DIALOGUES ---
    const messages = [
      "What are you doing? âœ‰ï¸",
      "I am learning about 'love'.",
      "Do you need a letter written?",
      "Auto Memories Doll service, at your disposal.",
      "Sincerely, Violet Evergarden.",
      "The scenery here is beautiful...",
    ];

    let speechTimeout: any;
    function showSpeech() {
      if (!speech) return;
      clearTimeout(speechTimeout);
      speech.textContent =
        messages[Math.floor(Math.random() * messages.length)];

      animate(speech, {
        opacity: [0, 1],
        translateY: [10, 0],
        duration: 500,
        easing: "easeOutExpo",
      });

      speechTimeout = setTimeout(() => {
        animate(speech, {
          opacity: 0,
          translateY: -10,
          duration: 500,
          easing: "easeInExpo",
        });
      }, 5000);
    }

    widget.addEventListener("click", (e) => {
      if (!isDragging && (e.target as HTMLElement).closest("div")) {
        showSpeech();
      }
    });

    // Auto speech interval
    setInterval(() => {
      if (Math.random() > 0.7) showSpeech();
    }, 20000);

    // --- EYE TRACKING ---
    const updateIris = (e: MouseEvent) => {
      if (!iris) return;
      const rect = widget.getBoundingClientRect();
      const eyeX = rect.left + rect.width * 0.638;
      const eyeY = rect.top + rect.height * 0.346;

      const dx = e.clientX - eyeX;
      const dy = e.clientY - eyeY;
      const angle = Math.atan2(dy, dx);
      const dist = Math.min(5, Math.hypot(dx, dy) / 40);

      iris.style.transform = `translate(calc(-50% + ${Math.cos(angle) * dist}px), calc(-50% + ${Math.sin(angle) * dist}px))`;
    };

    window.addEventListener("mousemove", updateIris);

    // --- BLINKING ---
    function blink() {
      if (!eyelid) return;
      animate(eyelid, {
        scaleY: [0, 1, 0],
        duration: 180,
        easing: "easeInOutQuad",
        onComplete: () => setTimeout(blink, 3000 + Math.random() * 5000),
      });
    }
    blink();

    if (closeBtn) {
      closeBtn.onclick = () => {
        widget.style.opacity = "0";
        widget.style.transform = "scale(0.8)";
        setTimeout(() => (widget.style.display = "none"), 300);
      };
    }
  }

  // Handle initialization and View Transitions
  initWidget();
  document.addEventListener("astro:after-swap", initWidget);
</script>
