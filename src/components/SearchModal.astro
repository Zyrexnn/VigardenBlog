---
// SearchModal.astro — Optimized search with instant results
import { getCollection } from "astro:content";

const blogs = await getCollection("blog");
const letters = await getCollection("letters");

const searchIndex = [
  ...blogs.map((post) => ({
    type: "blog",
    slug: post.id,
    title: post.data.title,
    title_jp: post.data.title_jp || "",
    title_id: post.data.title_id || "",
    description: post.data.description || "",
    category: post.data.category || "",
    tags: post.data.tags || [],
    url: `/blog/${post.id}/`,
  })),
  ...letters.map((letter) => ({
    type: "letter",
    slug: letter.id,
    title: letter.data.title,
    title_jp: letter.data.title_jp || "",
    title_id: letter.data.title_id || "",
    description: letter.data.description || "",
    sender: letter.data.sender || "",
    recipient: letter.data.recipient || "",
    url: `/letters/${letter.id}/`,
  })),
];
---

<!-- Search Trigger Button -->
<button
  id="search-trigger"
  class="flex items-center gap-2 h-8 sm:h-9 px-3 sm:px-4 rounded-full bg-ink/5 dark:bg-white/5 border border-ink/10 dark:border-white/10 hover:bg-ink/10 dark:hover:bg-white/10 transition-all duration-300 group"
  title="Search (Ctrl+K)"
  aria-label="Search"
>
  <svg
    class="w-3.5 h-3.5 text-ink/50 dark:text-white/50 group-hover:text-accent dark:group-hover:text-gold transition-colors"
    fill="none"
    viewBox="0 0 24 24"
    stroke="currentColor"
    stroke-width="2"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
    ></path>
  </svg>
  <span
    class="text-[10px] text-ink/35 dark:text-white/25 hidden sm:inline font-mono"
    >Ctrl+K</span
  >
</button>

<!-- Search Modal Overlay -->
<div
  id="search-modal"
  class="fixed inset-0 z-[300] flex items-start justify-center pt-[12vh] sm:pt-[15vh] px-3 sm:px-4 transition-all duration-200 opacity-0 pointer-events-none"
>
  <!-- Backdrop -->
  <div
    id="search-backdrop"
    class="absolute inset-0 bg-ink/30 dark:bg-black/50 backdrop-blur-sm"
  >
  </div>

  <!-- Search Box -->
  <div
    class="relative w-full max-w-lg bg-white dark:bg-[#1a1a2e] border border-ink/10 dark:border-white/10 rounded-2xl shadow-2xl overflow-hidden"
    id="search-box"
  >
    <!-- Input Area -->
    <div class="relative flex items-center">
      <svg
        class="absolute left-4 w-5 h-5 text-gold/50"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
        ></path>
      </svg>
      <input
        id="search-input"
        type="text"
        placeholder="Cari artikel atau surat..."
        class="w-full h-12 sm:h-14 pl-12 pr-12 bg-transparent text-ink dark:text-white text-sm sm:text-base font-body placeholder:text-ink/30 dark:placeholder:text-white/25 focus:outline-none"
        autocomplete="off"
      />
      <button
        id="search-close"
        class="absolute right-3 text-[9px] font-mono text-ink/30 dark:text-white/20 px-1.5 py-0.5 rounded border border-ink/10 dark:border-white/10 hover:bg-ink/5 dark:hover:bg-white/5 transition-colors"
        aria-label="Close"
      >
        ESC
      </button>
    </div>

    <!-- Results Area -->
    <div id="search-results" class="max-h-[55vh] overflow-y-auto">
      <!-- Initial state: show all items grouped -->
      <div id="search-initial" class="p-2">
        <p
          class="px-3 pt-2 pb-1 text-[9px] font-bold text-gold/50 uppercase tracking-[0.2em]"
        >
          Artikel
        </p>
        {
          blogs.map((post) => (
            <a
              href={`/blog/${post.id}/`}
              class="search-result flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gold/8 dark:hover:bg-white/5 transition-colors group"
              data-url={`/blog/${post.id}/`}
            >
              <svg
                class="w-4 h-4 text-gold/40 shrink-0"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"
                />
              </svg>
              <div class="min-w-0 flex-1">
                <p
                  class="text-sm font-heading text-ink dark:text-white group-hover:text-accent dark:group-hover:text-gold transition-colors truncate"
                  data-search-title={post.data.title}
                  data-search-title-jp={post.data.title_jp || ""}
                  data-search-title-id={post.data.title_id || ""}
                >
                  {post.data.title}
                </p>
                <p class="text-[11px] text-ink/40 dark:text-white/30 truncate">
                  {post.data.description}
                </p>
              </div>
              <span class="text-[9px] text-ink/20 dark:text-white/15 shrink-0">
                →
              </span>
            </a>
          ))
        }

        <p
          class="px-3 pt-3 pb-1 text-[9px] font-bold text-gold/50 uppercase tracking-[0.2em]"
        >
          Surat
        </p>
        {
          letters.map((letter) => (
            <a
              href={`/letters/${letter.id}/`}
              class="search-result flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gold/8 dark:hover:bg-white/5 transition-colors group"
              data-url={`/letters/${letter.id}/`}
            >
              <svg
                class="w-4 h-4 text-gold/40 shrink-0"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"
                />
              </svg>
              <div class="min-w-0 flex-1">
                <p
                  class="text-sm font-heading text-ink dark:text-white group-hover:text-accent dark:group-hover:text-gold transition-colors truncate"
                  data-search-title={letter.data.title}
                  data-search-title-jp={letter.data.title_jp || ""}
                  data-search-title-id={letter.data.title_id || ""}
                >
                  {letter.data.title}
                </p>
                <p class="text-[11px] text-ink/40 dark:text-white/30 truncate">
                  — {letter.data.sender}
                </p>
              </div>
              <span class="text-[9px] text-ink/20 dark:text-white/15 shrink-0">
                →
              </span>
            </a>
          ))
        }
      </div>

      <!-- Filtered results -->
      <div id="search-filtered" class="p-2 hidden"></div>

      <!-- No Results -->
      <div id="search-no-results" class="hidden py-10 text-center">
        <p class="text-ink/30 dark:text-white/20 text-sm">Tidak ditemukan</p>
      </div>
    </div>

    <!-- Footer -->
    <div
      class="flex items-center justify-between px-4 py-2 bg-ink/[0.02] dark:bg-white/[0.02]"
    >
      <div class="flex items-center gap-3">
        <span
          class="flex items-center gap-1 text-[9px] text-ink/30 dark:text-white/20"
        >
          <kbd
            class="px-1 py-0.5 rounded bg-ink/5 dark:bg-white/5 border border-ink/10 dark:border-white/10 font-mono"
            >↑↓</kbd
          >
          navigasi
        </span>
        <span
          class="flex items-center gap-1 text-[9px] text-ink/30 dark:text-white/20"
        >
          <kbd
            class="px-1 py-0.5 rounded bg-ink/5 dark:bg-white/5 border border-ink/10 dark:border-white/10 font-mono"
            >↵</kbd
          >
          buka
        </span>
      </div>
      <span class="text-[9px] text-ink/25 dark:text-white/15" id="search-count"
      ></span>
    </div>
  </div>
</div>

<!-- Inline search data for instant search (no fetch needed) -->
<script is:inline define:vars={{ searchIndex }}>
  window.__searchIndex = searchIndex;
</script>

<script>
  document.addEventListener("astro:page-load", () => {
    const trigger = document.getElementById("search-trigger");
    const modal = document.getElementById("search-modal");
    const backdrop = document.getElementById("search-backdrop");
    const closeBtn = document.getElementById("search-close");
    const input = document.getElementById(
      "search-input",
    ) as HTMLInputElement | null;
    const initial = document.getElementById("search-initial");
    const filtered = document.getElementById("search-filtered");
    const noResults = document.getElementById("search-no-results");
    const countEl = document.getElementById("search-count");

    const searchData: any[] = (window as any).__searchIndex || [];
    let activeIndex = -1;

    function openSearch() {
      if (!modal || !input) return;
      modal.classList.remove("opacity-0", "pointer-events-none");
      modal.classList.add("opacity-100", "pointer-events-auto");
      document.body.style.overflow = "hidden";
      input.value = "";
      activeIndex = -1;
      showInitial();
      setTimeout(() => input.focus(), 50);
    }

    function closeSearch() {
      if (!modal) return;
      modal.classList.add("opacity-0", "pointer-events-none");
      modal.classList.remove("opacity-100", "pointer-events-auto");
      document.body.style.overflow = "";
    }

    function showInitial() {
      if (initial) initial.classList.remove("hidden");
      if (filtered) filtered.classList.add("hidden");
      if (noResults) noResults.classList.add("hidden");
      if (countEl) countEl.textContent = `${searchData.length} item`;
      activeIndex = -1;
      clearHighlight();
    }

    function highlightMatch(text: string, query: string): string {
      if (!query) return text;
      const regex = new RegExp(
        `(${query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
        "gi",
      );
      return text.replace(
        regex,
        '<mark class="bg-gold/20 text-ink dark:text-white rounded px-0.5">$1</mark>',
      );
    }

    function performSearch(query: string) {
      const q = query.toLowerCase().trim();

      if (!q) {
        showInitial();
        return;
      }

      if (initial) initial.classList.add("hidden");
      if (filtered) filtered.classList.remove("hidden");

      const results = searchData.filter((item) => {
        const fields = [
          item.title,
          item.title_jp,
          item.title_id,
          item.description || "",
          item.category || "",
          item.sender || "",
          item.recipient || "",
          ...(item.tags || []),
        ].map((f: string) => f.toLowerCase());
        return fields.some((f) => f.includes(q));
      });

      if (results.length === 0) {
        if (filtered) filtered.innerHTML = "";
        if (noResults) noResults.classList.remove("hidden");
        if (countEl) countEl.textContent = "0 item";
        return;
      }

      if (noResults) noResults.classList.add("hidden");
      if (countEl) countEl.textContent = `${results.length} ditemukan`;

      if (filtered) {
        filtered.innerHTML = results
          .map((item, idx) => {
            const icon =
              item.type === "blog"
                ? `<svg class="w-4 h-4 text-gold/40 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>`
                : `<svg class="w-4 h-4 text-gold/40 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" /></svg>`;

            const typeLabel = item.type === "blog" ? "Artikel" : "Surat";
            const desc =
              item.description || (item.sender ? `— ${item.sender}` : "");

            return `
            <a href="${item.url}" class="search-result-item flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gold/8 dark:hover:bg-white/5 transition-colors group" data-idx="${idx}">
              ${icon}
              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2">
                  <span class="text-[8px] uppercase tracking-[0.15em] text-gold/40 font-bold">${typeLabel}</span>
                </div>
                <p class="text-sm font-heading text-ink dark:text-white group-hover:text-accent dark:group-hover:text-gold transition-colors truncate">${highlightMatch(item.title, q)}</p>
                <p class="text-[11px] text-ink/40 dark:text-white/30 truncate">${highlightMatch(desc, q)}</p>
              </div>
              <span class="text-[9px] text-ink/20 dark:text-white/15 shrink-0">→</span>
            </a>
          `;
          })
          .join("");
      }

      activeIndex = -1;
      clearHighlight();
    }

    function getVisibleResults(): NodeListOf<Element> | null {
      if (initial && !initial.classList.contains("hidden")) {
        return initial.querySelectorAll(".search-result");
      }
      if (filtered && !filtered.classList.contains("hidden")) {
        return filtered.querySelectorAll(".search-result-item");
      }
      return null;
    }

    function clearHighlight() {
      const items = getVisibleResults();
      if (items)
        items.forEach((el) =>
          el.classList.remove("bg-gold/10", "dark:bg-white/5"),
        );
    }

    function highlightItem(idx: number) {
      const items = getVisibleResults();
      if (!items || items.length === 0) return;
      clearHighlight();
      activeIndex = Math.max(0, Math.min(idx, items.length - 1));
      const el = items[activeIndex] as HTMLElement;
      el.classList.add("bg-gold/10", "dark:bg-white/5");
      el.scrollIntoView({ block: "nearest" });
    }

    function navigateToActive() {
      const items = getVisibleResults();
      if (!items || activeIndex < 0 || activeIndex >= items.length) return;
      const el = items[activeIndex] as HTMLAnchorElement;
      if (el.href) window.location.href = el.href;
    }

    // Events
    if (trigger) trigger.addEventListener("click", openSearch);
    if (closeBtn) closeBtn.addEventListener("click", closeSearch);
    if (backdrop) backdrop.addEventListener("click", closeSearch);

    document.addEventListener("keydown", (e) => {
      // Open
      if ((e.ctrlKey || e.metaKey) && e.key === "k") {
        e.preventDefault();
        openSearch();
        return;
      }

      // Only handle below if modal is open
      if (!modal || modal.classList.contains("pointer-events-none")) return;

      if (e.key === "Escape") {
        e.preventDefault();
        closeSearch();
      }

      if (e.key === "ArrowDown") {
        e.preventDefault();
        highlightItem(activeIndex + 1);
      }

      if (e.key === "ArrowUp") {
        e.preventDefault();
        highlightItem(activeIndex - 1);
      }

      if (e.key === "Enter") {
        e.preventDefault();
        navigateToActive();
      }
    });

    // Instant search on type (no debounce for small dataset)
    if (input) {
      input.addEventListener("input", () => {
        performSearch(input.value);
      });
    }
  });
</script>
