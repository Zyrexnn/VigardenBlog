---
/**
 * ThemeController.astro
 * Anti-flicker dark/light toggle.
 * Uses is:inline so the script runs BEFORE painting.
 */
---

<!-- Toggle Button -->
<button
  id="theme-toggle"
  type="button"
  aria-label="Toggle dark mode"
  class="w-10 h-10 rounded-full flex items-center justify-center
         text-ink dark:text-white hover:bg-black/5 dark:hover:bg-white/10
         transition-all duration-300 group relative overflow-hidden"
>
  <!-- Sun Icon (visible in dark mode) -->
  <svg
    class="w-5 h-5 text-gold absolute transition-all duration-200
           scale-0 rotate-90 dark:scale-100 dark:rotate-0"
    fill="none"
    viewBox="0 0 24 24"
    stroke="currentColor"
    stroke-width="2"
  >
    <circle cx="12" cy="12" r="5"></circle>
    <path
      d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
    ></path>
  </svg>

  <!-- Moon Icon (visible in light mode) -->
  <svg
    class="w-5 h-5 text-post-blue absolute transition-all duration-200
           scale-100 rotate-0 dark:scale-0 dark:-rotate-90"
    fill="none"
    viewBox="0 0 24 24"
    stroke="currentColor"
    stroke-width="2"
  >
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
  </svg>
</button>

<script is:inline>
  // ── Theme Toggle ──────────────────────────────────────────
  // is:inline = runs synchronously BEFORE paint. No flicker.
  (function initThemeToggle() {
    var btn = document.getElementById("theme-toggle");
    if (!btn) return;

    // Remove previous listener by replacing the node
    var fresh = btn.cloneNode(true);
    btn.parentNode.replaceChild(fresh, btn);

    fresh.addEventListener("click", function () {
      var html = document.documentElement;
      html.classList.toggle("dark");
      var nowDark = html.classList.contains("dark");
      localStorage.setItem("theme", nowDark ? "dark" : "light");

      // Let other scripts know (GIF sync, etc.)
      window.dispatchEvent(
        new CustomEvent("theme-changed", {
          detail: { theme: nowDark ? "dark" : "light" },
        }),
      );
    });
  })();

  // Re-bind after every View Transition swap
  document.addEventListener("astro:after-swap", function () {
    // 1. Re-apply saved theme instantly (anti-flicker on navigation)
    var stored = localStorage.getItem("theme");
    if (
      stored === "dark" ||
      (!stored && window.matchMedia("(prefers-color-scheme: dark)").matches)
    ) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }

    // 2. Re-bind the toggle button
    var btn = document.getElementById("theme-toggle");
    if (!btn) return;
    var fresh = btn.cloneNode(true);
    btn.parentNode.replaceChild(fresh, btn);

    fresh.addEventListener("click", function () {
      var html = document.documentElement;
      html.classList.toggle("dark");
      var nowDark = html.classList.contains("dark");
      localStorage.setItem("theme", nowDark ? "dark" : "light");
      window.dispatchEvent(
        new CustomEvent("theme-changed", {
          detail: { theme: nowDark ? "dark" : "light" },
        }),
      );
    });
  });

  // ── Sync Theme GIF ──────────────────────────────────────────
  function syncThemeGif(isDark) {
    var gif = document.getElementById("theme-gif");
    if (gif) {
      var newSrc = isDark
        ? "/images/violet-dark.gif"
        : "/images/violet-light.gif";
      if (gif.getAttribute("src") !== newSrc) {
        gif.setAttribute("src", newSrc);
      }
    }
  }

  window.addEventListener("theme-changed", function (e) {
    syncThemeGif(e.detail.theme === "dark");
  });

  document.addEventListener("astro:page-load", function () {
    var isDark = document.documentElement.classList.contains("dark");
    syncThemeGif(isDark);
  });
</script>
