---
/**
 * MusicPlayer.astro ‚Äî Compact Spotify-style fixed bottom audio player
 * Violet Evergarden OST player with glassmorphism design
 */
---

<!-- Minimized Toggle Button -->
<button
  id="music-toggle-btn"
  class="fixed bottom-4 right-4 z-[150] w-10 h-10 rounded-full
         bg-[#181818]/90 backdrop-blur-xl shadow-lg
         flex items-center justify-center
         hover:scale-110 transition-all duration-300
         border border-white/10"
  aria-label="Open Music Player"
>
  <span class="text-base" id="toggle-icon">üéµ</span>
</button>

<!-- Compact Player Bar -->
<div
  id="music-player"
  class="fixed bottom-0 left-0 right-0 z-[140]
         translate-y-full opacity-0 transition-all duration-500 ease-out"
>
  <div
    class="mx-2 sm:mx-auto sm:max-w-md mb-2 rounded-xl overflow-hidden
           bg-[#181818]/95 backdrop-blur-2xl
           border border-white/[0.06] shadow-[0_-4px_20px_rgba(0,0,0,0.3)]"
  >
    <!-- Main Row -->
    <div class="flex items-center gap-2.5 p-2">
      <!-- Album Art -->
      <div class="relative flex-shrink-0">
        <div
          id="album-art"
          class="w-10 h-10 rounded-md overflow-hidden shadow-md"
        >
          <img
            src="/images/coverlagu.jpg"
            alt="Album Cover"
            class="w-full h-full object-cover"
            id="album-img"
          />
        </div>
        <!-- Playing indicator -->
        <div
          id="playing-dots"
          class="absolute -bottom-0.5 left-1/2 -translate-x-1/2 flex gap-px opacity-0 transition-opacity"
        >
          <span
            class="w-0.5 h-0.5 rounded-full bg-[#1DB954] animate-bounce"
            style="animation-delay: 0ms;"></span>
          <span
            class="w-0.5 h-0.5 rounded-full bg-[#1DB954] animate-bounce"
            style="animation-delay: 150ms;"></span>
          <span
            class="w-0.5 h-0.5 rounded-full bg-[#1DB954] animate-bounce"
            style="animation-delay: 300ms;"></span>
        </div>
      </div>

      <!-- Track Info (compact) -->
      <div class="flex-1 min-w-0">
        <p
          id="track-title"
          class="text-[11px] sm:text-xs font-semibold text-white truncate leading-tight"
        >
          „Åø„Å°„Åó„Çã„Åπ (Michishirube)
        </p>
        <p
          id="track-artist"
          class="text-[9px] sm:text-[10px] text-white/40 truncate leading-tight"
        >
          Minori Chihara
        </p>
      </div>

      <!-- Controls (compact) -->
      <div class="flex items-center gap-0.5 flex-shrink-0">
        <!-- Previous -->
        <button
          id="btn-prev"
          class="w-6 h-6 flex items-center justify-center text-white/50 hover:text-white transition-colors"
          title="Previous"
        >
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path>
          </svg>
        </button>

        <!-- Play/Pause -->
        <button
          id="btn-play"
          class="w-7 h-7 rounded-full bg-white flex items-center justify-center
                 hover:scale-105 active:scale-95 transition-all duration-150 shadow"
          title="Play"
        >
          <svg
            id="icon-play"
            class="w-3 h-3 text-black ml-px"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path d="M8 5v14l11-7z"></path>
          </svg>
          <svg
            id="icon-pause"
            class="w-3 h-3 text-black hidden"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>
          </svg>
        </button>

        <!-- Next -->
        <button
          id="btn-next"
          class="w-6 h-6 flex items-center justify-center text-white/50 hover:text-white transition-colors"
          title="Next"
        >
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"></path>
          </svg>
        </button>

        <!-- Volume (desktop only) -->
        <div class="hidden sm:flex items-center gap-0.5 ml-1">
          <button
            id="btn-volume"
            class="w-5 h-5 flex items-center justify-center text-white/40 hover:text-white transition-colors"
            title="Volume"
          >
            <svg
              id="vol-icon"
              class="w-3 h-3"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"
              ></path>
            </svg>
            <svg
              id="vol-mute-icon"
              class="w-3 h-3 hidden"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"
              ></path>
            </svg>
          </button>
          <input
            id="volume-slider"
            type="range"
            min="0"
            max="100"
            value="70"
            class="volume-range w-12"
          />
        </div>

        <!-- Collapse -->
        <button
          id="btn-collapse"
          class="w-5 h-5 flex items-center justify-center text-white/20 hover:text-white/50 transition-colors ml-0.5"
          title="Minimize"
        >
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"
            ></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Progress Bar (full width, thin) -->
    <div
      id="progress-container"
      class="h-[3px] bg-white/10 cursor-pointer -mt-px"
    >
      <div
        id="progress-bar"
        class="h-full bg-[#1DB954] transition-[width] duration-100 relative"
        style="width: 0%;"
      >
        <div
          class="absolute right-0 top-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-white opacity-0 hover:opacity-100 shadow-sm"
        >
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .volume-range {
    -webkit-appearance: none;
    appearance: none;
    height: 3px;
    border-radius: 2px;
    background: rgba(255, 255, 255, 0.12);
    outline: none;
    cursor: pointer;
  }
  .volume-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: white;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .volume-range:hover::-webkit-slider-thumb {
    opacity: 1;
  }
  .volume-range::-moz-range-thumb {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: white;
    cursor: pointer;
    border: none;
  }
</style>

<script>
  document.addEventListener("astro:page-load", () => {
    const player = document.getElementById("music-player");
    const toggleBtn = document.getElementById("music-toggle-btn");
    const toggleIcon = document.getElementById("toggle-icon");
    const collapseBtn = document.getElementById("btn-collapse");
    const playBtn = document.getElementById("btn-play");
    const prevBtn = document.getElementById("btn-prev");
    const nextBtn = document.getElementById("btn-next");
    const iconPlay = document.getElementById("icon-play");
    const iconPause = document.getElementById("icon-pause");
    const trackTitle = document.getElementById("track-title");
    const trackArtist = document.getElementById("track-artist");
    const progressContainer = document.getElementById("progress-container");
    const progressBar = document.getElementById("progress-bar");
    const volumeSlider = document.getElementById(
      "volume-slider",
    ) as HTMLInputElement;
    const volumeBtn = document.getElementById("btn-volume");
    const volIcon = document.getElementById("vol-icon");
    const volMuteIcon = document.getElementById("vol-mute-icon");
    const playingDots = document.getElementById("playing-dots");
    const albumImg = document.getElementById("album-img") as HTMLImageElement;

    if (!player || !toggleBtn || !playBtn) return;

    // === Track List ===
    const tracks = [
      {
        title: "„Åø„Å°„Åó„Çã„Åπ (Michishirube)",
        artist: "Minori Chihara",
        src: "/audio/michishirube.mp3",
        cover: "/images/coverlagu.jpg",
      },
    ];

    let currentTrackIndex = 0;
    let isPlayerOpen = false;
    let audio: HTMLAudioElement | null = null;
    let isPlaying = false;
    let animFrameId: number;

    // === Audio Setup ===
    function initAudio() {
      if (audio) return;
      audio = new Audio();
      audio.preload = "metadata";

      const savedVolume = localStorage.getItem("vigarden-player-vol");
      const vol = savedVolume ? parseInt(savedVolume) : 70;
      audio.volume = vol / 100;
      if (volumeSlider) volumeSlider.value = String(vol);

      audio.addEventListener("ended", () => {
        if (tracks.length > 1) {
          nextTrack();
        } else {
          if (audio) {
            audio.currentTime = 0;
            audio.play();
          }
        }
      });

      loadTrack(currentTrackIndex);
    }

    function loadTrack(index: number) {
      if (!audio) return;
      const track = tracks[index];
      audio.src = track.src;
      if (trackTitle) trackTitle.textContent = track.title;
      if (trackArtist) trackArtist.textContent = track.artist;
      if (albumImg && track.cover) albumImg.src = track.cover;
    }

    // === Progress ===
    function updateProgress() {
      if (!audio || audio.paused) return;
      const pct = (audio.currentTime / audio.duration) * 100 || 0;
      if (progressBar) progressBar.style.width = `${pct}%`;
      animFrameId = requestAnimationFrame(updateProgress);
    }

    // === Play/Pause ===
    function togglePlay() {
      initAudio();
      if (!audio) return;
      if (isPlaying) {
        audio.pause();
        isPlaying = false;
      } else {
        audio.play().catch(() => {});
        isPlaying = true;
      }
      updatePlayUI();
    }

    function updatePlayUI() {
      if (isPlaying) {
        iconPlay?.classList.add("hidden");
        iconPause?.classList.remove("hidden");
        playingDots?.classList.remove("opacity-0");
        playingDots?.classList.add("opacity-100");
        if (toggleIcon) toggleIcon.textContent = "‚è∏Ô∏è";
        cancelAnimationFrame(animFrameId);
        animFrameId = requestAnimationFrame(updateProgress);
      } else {
        iconPlay?.classList.remove("hidden");
        iconPause?.classList.add("hidden");
        playingDots?.classList.add("opacity-0");
        playingDots?.classList.remove("opacity-100");
        if (toggleIcon) toggleIcon.textContent = "üéµ";
        cancelAnimationFrame(animFrameId);
      }
    }

    // === Next / Previous ===
    function nextTrack() {
      currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
      loadTrack(currentTrackIndex);
      if (isPlaying && audio) {
        audio.play().catch(() => {});
        animFrameId = requestAnimationFrame(updateProgress);
      }
    }

    function prevTrack() {
      if (audio && audio.currentTime > 3) {
        audio.currentTime = 0;
        return;
      }
      currentTrackIndex =
        (currentTrackIndex - 1 + tracks.length) % tracks.length;
      loadTrack(currentTrackIndex);
      if (isPlaying && audio) {
        audio.play().catch(() => {});
        animFrameId = requestAnimationFrame(updateProgress);
      }
    }

    // === Seek ===
    function seekFromClick(e: MouseEvent) {
      if (!audio || !audio.duration || !progressContainer) return;
      const rect = progressContainer.getBoundingClientRect();
      const pct = Math.max(
        0,
        Math.min(1, (e.clientX - rect.left) / rect.width),
      );
      audio.currentTime = pct * audio.duration;
      if (progressBar) progressBar.style.width = pct * 100 + "%";
    }

    // === Volume ===
    function updateVolume(val: number) {
      if (!audio) initAudio();
      if (audio) audio.volume = val / 100;
      localStorage.setItem("vigarden-player-vol", String(val));
      if (val === 0) {
        volIcon?.classList.add("hidden");
        volMuteIcon?.classList.remove("hidden");
      } else {
        volIcon?.classList.remove("hidden");
        volMuteIcon?.classList.add("hidden");
      }
    }

    // === Expand/Collapse ===
    function openPlayer() {
      isPlayerOpen = true;
      player!.classList.remove("translate-y-full", "opacity-0");
      player!.classList.add("translate-y-0", "opacity-100");
      toggleBtn!.classList.add("opacity-0", "pointer-events-none", "scale-75");
    }

    function closePlayer() {
      isPlayerOpen = false;
      player!.classList.add("translate-y-full", "opacity-0");
      player!.classList.remove("translate-y-0", "opacity-100");
      toggleBtn!.classList.remove(
        "opacity-0",
        "pointer-events-none",
        "scale-75",
      );
    }

    // === Event Listeners ===
    toggleBtn.addEventListener("click", () => {
      if (isPlayerOpen) closePlayer();
      else {
        openPlayer();
        initAudio();
      }
    });

    collapseBtn?.addEventListener("click", closePlayer);
    playBtn.addEventListener("click", togglePlay);
    nextBtn?.addEventListener("click", nextTrack);
    prevBtn?.addEventListener("click", prevTrack);
    progressContainer?.addEventListener("click", (e) =>
      seekFromClick(e as MouseEvent),
    );

    volumeSlider?.addEventListener("input", () =>
      updateVolume(parseInt(volumeSlider.value)),
    );
    volumeBtn?.addEventListener("click", () => {
      if (!audio) return;
      if (audio.volume > 0) {
        audio.dataset.prevVol = String(volumeSlider?.value || "70");
        updateVolume(0);
        if (volumeSlider) volumeSlider.value = "0";
      } else {
        const prev = parseInt(audio.dataset.prevVol || "70");
        updateVolume(prev);
        if (volumeSlider) volumeSlider.value = String(prev);
      }
    });

    // Keyboard: Space = play/pause
    document.addEventListener("keydown", (e) => {
      const tag = (e.target as HTMLElement).tagName;
      if (tag === "INPUT" || tag === "TEXTAREA") return;
      if (e.code === "Space" && isPlayerOpen) {
        e.preventDefault();
        togglePlay();
      }
    });
  });
</script>
