---
/**
 * MusicPlayer.astro ‚Äî Compact Spotify-style fixed bottom audio player
 * Violet Evergarden OST player with glassmorphism design
 */
---

<button
  id="music-toggle-btn"
  class="fixed bottom-3 right-3 sm:bottom-4 sm:right-4 z-[150] w-9 h-9 sm:w-10 sm:h-10 rounded-full
         bg-[#181818]/90 backdrop-blur-xl shadow-lg
         flex items-center justify-center
         hover:scale-110 active:scale-95 transition-all duration-300
         border border-white/10 focus:outline-none focus:ring-0"
  aria-label="Open Music Player"
>
  <span class="text-sm sm:text-base" id="toggle-icon">üéµ</span>
</button>

<div
  id="music-player"
  class="fixed bottom-0 left-0 right-0 z-[140]
         translate-y-full opacity-0 transition-all duration-200 ease-out"
>
  <div
    class="mx-1.5 sm:mx-2 md:mx-auto md:max-w-lg mb-1.5 sm:mb-2 rounded-xl overflow-hidden
           bg-[#181818]/95 backdrop-blur-2xl
           border border-white/[0.06] shadow-[0_-4px_20px_rgba(0,0,0,0.3)]"
  >
    <div class="flex items-center gap-2 p-2 sm:p-2.5">
      <div class="relative flex-shrink-0">
        <div
          id="album-art"
          class="w-9 h-9 sm:w-10 sm:h-10 rounded-md overflow-hidden shadow-md"
        >
          <img
            src="/images/coverlagu.jpg"
            alt="Album Cover"
            class="w-full h-full object-cover"
            id="album-img"
          />
        </div>
        <div
          id="playing-dots"
          class="absolute -bottom-0.5 left-1/2 -translate-x-1/2 flex gap-px opacity-0 transition-opacity"
        >
          <span
            class="w-0.5 h-0.5 rounded-full bg-[#1DB954] animate-bounce"
            style="animation-delay: 0ms;"></span>
          <span
            class="w-0.5 h-0.5 rounded-full bg-[#1DB954] animate-bounce"
            style="animation-delay: 150ms;"></span>
          <span
            class="w-0.5 h-0.5 rounded-full bg-[#1DB954] animate-bounce"
            style="animation-delay: 300ms;"></span>
        </div>
      </div>

      <div class="flex-1 min-w-0">
        <p
          id="track-title"
          class="text-[10px] sm:text-[11px] font-semibold text-white truncate leading-tight"
        >
          „Åø„Å°„Åó„Çã„Åπ (Michishirube)
        </p>
        <p
          id="track-artist"
          class="text-[8px] sm:text-[9px] text-white/40 truncate leading-tight"
        >
          Minori Chihara
        </p>
        <div class="flex items-center gap-1.5 mt-0.5 sm:hidden">
          <span id="time-current-mobile" class="text-[7px] text-white/50 font-mono">0:00</span>
          <span class="text-[7px] text-white/30">/</span>
          <span id="time-duration-mobile" class="text-[7px] text-white/50 font-mono">0:00</span>
        </div>
      </div>

      <div class="flex items-center gap-0.5 sm:gap-1 flex-shrink-0">
        <button
          id="btn-prev"
          class="w-5 h-5 sm:w-6 sm:h-6 flex items-center justify-center text-white/50 hover:text-white transition-colors focus:outline-none"
          title="Previous"
        >
          <svg class="w-2.5 h-2.5 sm:w-3 sm:h-3" fill="currentColor" viewBox="0 0 24 24">
            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path>
          </svg>
        </button>

        <button
          id="btn-play"
          class="w-6 h-6 sm:w-7 sm:h-7 rounded-full bg-white flex items-center justify-center
                 hover:scale-105 active:scale-95 transition-all duration-150 shadow focus:outline-none"
          title="Play"
        >
          <svg
            id="icon-play"
            class="w-2.5 h-2.5 sm:w-3 sm:h-3 text-black ml-px"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path d="M8 5v14l11-7z"></path>
          </svg>
          <svg
            id="icon-pause"
            class="w-2.5 h-2.5 sm:w-3 sm:h-3 text-black hidden"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>
          </svg>
        </button>

        <button
          id="btn-next"
          class="w-5 h-5 sm:w-6 sm:h-6 flex items-center justify-center text-white/50 hover:text-white transition-colors focus:outline-none"
          title="Next"
        >
          <svg class="w-2.5 h-2.5 sm:w-3 sm:h-3" fill="currentColor" viewBox="0 0 24 24">
            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"></path>
          </svg>
        </button>

        <div class="hidden sm:flex items-center gap-0.5 ml-0.5">
          <button
            id="btn-volume"
            class="w-5 h-5 flex items-center justify-center text-white/40 hover:text-white transition-colors focus:outline-none"
            title="Volume"
          >
            <svg
              id="vol-icon"
              class="w-3 h-3"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"
              ></path>
            </svg>
            <svg
              id="vol-mute-icon"
              class="w-3 h-3 hidden"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"
              ></path>
            </svg>
          </button>
          <input
            id="volume-slider"
            type="range"
            min="0"
            max="100"
            value="70"
            class="volume-range w-10 sm:w-12"
          />
        </div>

        <button
          id="btn-collapse"
          class="w-5 h-5 flex items-center justify-center text-white/20 hover:text-white/50 transition-colors ml-0.5 focus:outline-none"
          title="Minimize"
        >
          <svg class="w-2.5 h-2.5 sm:w-3 sm:h-3" fill="currentColor" viewBox="0 0 24 24">
            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"
            ></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="flex items-center px-2 sm:px-3 gap-2 sm:gap-3">
      <span id="time-current" class="text-[8px] sm:text-[9px] text-white/50 font-mono w-7 sm:w-8 text-right hidden sm:block">0:00</span>
      <div
        id="progress-container"
        class="flex-1 h-[3px] bg-white/10 cursor-pointer rounded-full relative group"
      >
        <div
          id="progress-bar"
          class="h-full bg-[#1DB954] transition-[width] duration-75 relative rounded-full"
          style="width: 0%;"
        >
          <div
            class="absolute right-0 top-1/2 -translate-y-1/2 w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full bg-white opacity-0 group-hover:opacity-100 shadow-sm transition-opacity"
          >
          </div>
        </div>
      </div>
      <span id="time-duration" class="text-[8px] sm:text-[9px] text-white/50 font-mono w-7 sm:w-8 hidden sm:block">0:00</span>
    </div>
  </div>
</div>

<style>
  .volume-range {
    -webkit-appearance: none;
    appearance: none;
    height: 3px;
    border-radius: 2px;
    background: rgba(255, 255, 255, 0.12);
    outline: none;
    cursor: pointer;
  }
  .volume-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: white;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .volume-range:hover::-webkit-slider-thumb {
    opacity: 1;
  }
  .volume-range::-moz-range-thumb {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: white;
    cursor: pointer;
    border: none;
  }
</style>

<script is:inline>
  (function() {
    var TRACKS = [
      {
        title: "„Åø„Å°„Åó„Çã„Åπ (Michishirube)",
        artist: "Minori Chihara",
        src: "/audio/michishirube.mp3",
        cover: "/images/coverlagu.jpg",
      },
    ];

    var STORAGE_KEY = "vigarden-music-state";
    var audio = window.__vigardenAudio || null;
    var animFrameId = null;

    function getState() {
      try {
        var saved = localStorage.getItem(STORAGE_KEY);
        if (saved) return JSON.parse(saved);
      } catch (e) {}
      return { trackIndex: 0, currentTime: 0, volume: 70, isPlaying: false, isOpen: false };
    }

    function saveState(state) {
      try {
        var current = getState();
        var merged = Object.assign({}, current, state);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(merged));
      } catch (e) {}
    }

    function formatTime(seconds) {
      if (!seconds || !isFinite(seconds)) return "0:00";
      var mins = Math.floor(seconds / 60);
      var secs = Math.floor(seconds % 60);
      return mins + ":" + (secs < 10 ? "0" : "") + secs;
    }

    function getEl(id) {
      return document.getElementById(id);
    }

    function initAudio() {
      if (audio) return audio;
      audio = new Audio();
      audio.preload = "metadata";
      window.__vigardenAudio = audio;

      var state = getState();
      audio.volume = state.volume / 100;

      audio.addEventListener("loadedmetadata", function() {
        updateDurationDisplay();
        if (state.currentTime > 0) {
          audio.currentTime = state.currentTime;
        }
      });

      audio.addEventListener("ended", function() {
        if (TRACKS.length > 1) {
          nextTrack();
        } else {
          audio.currentTime = 0;
          audio.play();
        }
      });

      audio.addEventListener("timeupdate", function() {
        updateProgress();
      });

      audio.addEventListener("play", function() {
        updatePlayUI(true);
      });

      audio.addEventListener("pause", function() {
        updatePlayUI(false);
      });

      loadTrack(state.trackIndex);
      return audio;
    }

    function loadTrack(index) {
      if (!audio) return;
      var track = TRACKS[index];
      audio.src = track.src;
      var titleEl = getEl("track-title");
      var artistEl = getEl("track-artist");
      var albumImg = getEl("album-img");
      if (titleEl) titleEl.textContent = track.title;
      if (artistEl) artistEl.textContent = track.artist;
      if (albumImg && track.cover) albumImg.src = track.cover;
    }

    function updateProgress() {
      if (!audio) return;
      var pct = (audio.currentTime / audio.duration) * 100 || 0;
      var progressBar = getEl("progress-bar");
      if (progressBar) progressBar.style.width = pct + "%";

      var timeCurrent = getEl("time-current");
      var timeCurrentMobile = getEl("time-current-mobile");
      if (timeCurrent) timeCurrent.textContent = formatTime(audio.currentTime);
      if (timeCurrentMobile) timeCurrentMobile.textContent = formatTime(audio.currentTime);

      saveState({ currentTime: audio.currentTime });
    }

    function updateDurationDisplay() {
      if (!audio) return;
      var duration = audio.duration;
      var timeDuration = getEl("time-duration");
      var timeDurationMobile = getEl("time-duration-mobile");
      if (timeDuration) timeDuration.textContent = formatTime(duration);
      if (timeDurationMobile) timeDurationMobile.textContent = formatTime(duration);
    }

    function updatePlayUI(isPlaying) {
      var iconPlay = getEl("icon-play");
      var iconPause = getEl("icon-pause");
      var playingDots = getEl("playing-dots");
      var toggleIcon = getEl("toggle-icon");

      if (isPlaying) {
        if (iconPlay) iconPlay.classList.add("hidden");
        if (iconPause) iconPause.classList.remove("hidden");
        if (playingDots) {
          playingDots.classList.remove("opacity-0");
          playingDots.classList.add("opacity-100");
        }
        if (toggleIcon) toggleIcon.textContent = "‚è∏Ô∏è";
      } else {
        if (iconPlay) iconPlay.classList.remove("hidden");
        if (iconPause) iconPause.classList.add("hidden");
        if (playingDots) {
          playingDots.classList.add("opacity-0");
          playingDots.classList.remove("opacity-100");
        }
        if (toggleIcon) toggleIcon.textContent = "üéµ";
      }
      saveState({ isPlaying: isPlaying });
    }

    function togglePlay() {
      initAudio();
      if (!audio) return;

      if (audio.paused) {
        audio.play().catch(function() {});
      } else {
        audio.pause();
      }
    }

    function nextTrack() {
      var state = getState();
      state.trackIndex = (state.trackIndex + 1) % TRACKS.length;
      loadTrack(state.trackIndex);
      saveState({ trackIndex: state.trackIndex, currentTime: 0 });
      if (audio && !audio.paused) {
        audio.play().catch(function() {});
      }
    }

    function prevTrack() {
      if (audio && audio.currentTime > 3) {
        audio.currentTime = 0;
        return;
      }
      var state = getState();
      state.trackIndex = (state.trackIndex - 1 + TRACKS.length) % TRACKS.length;
      loadTrack(state.trackIndex);
      saveState({ trackIndex: state.trackIndex, currentTime: 0 });
      if (audio && !audio.paused) {
        audio.play().catch(function() {});
      }
    }

    function seekFromClick(e) {
      if (!audio || !audio.duration) return;
      var container = getEl("progress-container");
      if (!container) return;
      var rect = container.getBoundingClientRect();
      var pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
      audio.currentTime = pct * audio.duration;
      var progressBar = getEl("progress-bar");
      if (progressBar) progressBar.style.width = (pct * 100) + "%";
      saveState({ currentTime: audio.currentTime });
    }

    function updateVolume(val) {
      initAudio();
      if (audio) audio.volume = val / 100;
      saveState({ volume: val });

      var volIcon = getEl("vol-icon");
      var volMuteIcon = getEl("vol-mute-icon");
      if (val === 0) {
        if (volIcon) volIcon.classList.add("hidden");
        if (volMuteIcon) volMuteIcon.classList.remove("hidden");
      } else {
        if (volIcon) volIcon.classList.remove("hidden");
        if (volMuteIcon) volMuteIcon.classList.add("hidden");
      }
    }

    function openPlayer() {
      var player = getEl("music-player");
      var toggleBtn = getEl("music-toggle-btn");
      if (player) {
        player.classList.remove("translate-y-full", "opacity-0");
        player.classList.add("translate-y-0", "opacity-100");
      }
      if (toggleBtn) toggleBtn.classList.add("opacity-0", "pointer-events-none", "scale-75");
      saveState({ isOpen: true });
    }

    function closePlayer() {
      var player = getEl("music-player");
      var toggleBtn = getEl("music-toggle-btn");
      if (player) {
        player.classList.add("translate-y-full", "opacity-0");
        player.classList.remove("translate-y-0", "opacity-100");
      }
      if (toggleBtn) toggleBtn.classList.remove("opacity-0", "pointer-events-none", "scale-75");
      saveState({ isOpen: false });
    }

    function bindEvents() {
      var toggleBtn = getEl("music-toggle-btn");
      var collapseBtn = getEl("btn-collapse");
      var playBtn = getEl("btn-play");
      var prevBtn = getEl("btn-prev");
      var nextBtn = getEl("btn-next");
      var progressContainer = getEl("progress-container");
      var volumeSlider = getEl("volume-slider");
      var volumeBtn = getEl("btn-volume");

      if (toggleBtn) {
        toggleBtn.onclick = function() {
          var state = getState();
          if (state.isOpen) {
            closePlayer();
          } else {
            openPlayer();
            initAudio();
          }
        };
      }

      if (collapseBtn) collapseBtn.onclick = closePlayer;
      if (playBtn) playBtn.onclick = togglePlay;
      if (prevBtn) prevBtn.onclick = prevTrack;
      if (nextBtn) nextBtn.onclick = nextTrack;
      if (progressContainer) progressContainer.onclick = seekFromClick;

      if (volumeSlider) {
        volumeSlider.oninput = function() {
          updateVolume(parseInt(volumeSlider.value));
        };
      }

      if (volumeBtn) {
        volumeBtn.onclick = function() {
          if (!audio) return;
          if (audio.volume > 0) {
            audio.dataset.prevVol = volumeSlider ? volumeSlider.value : "70";
            updateVolume(0);
            if (volumeSlider) volumeSlider.value = "0";
          } else {
            var prev = parseInt(audio.dataset.prevVol || "70");
            updateVolume(prev);
            if (volumeSlider) volumeSlider.value = String(prev);
          }
        };
      }

      document.onkeydown = function(e) {
        var tag = e.target.tagName;
        if (tag === "INPUT" || tag === "TEXTAREA") return;
        var state = getState();
        if (e.code === "Space" && state.isOpen) {
          e.preventDefault();
          togglePlay();
        }
      };
    }

    function init() {
      var state = getState();

      if (state.isOpen) {
        var player = getEl("music-player");
        var toggleBtn = getEl("music-toggle-btn");
        if (player) {
          player.classList.remove("translate-y-full", "opacity-0");
          player.classList.add("translate-y-0", "opacity-100");
        }
        if (toggleBtn) toggleBtn.classList.add("opacity-0", "pointer-events-none", "scale-75");
      }

      if (audio) {
        var volumeSlider = getEl("volume-slider");
        if (volumeSlider) volumeSlider.value = String(Math.round(audio.volume * 100));
        updatePlayUI(!audio.paused);
        updateDurationDisplay();
        updateProgress();
      } else {
        var volumeSlider = getEl("volume-slider");
        if (volumeSlider) volumeSlider.value = String(state.volume);
      }

      bindEvents();

      if (state.isPlaying && !audio) {
        initAudio();
        audio.play().catch(function() {});
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }

    document.addEventListener("astro:page-load", init);
  })();
</script>
