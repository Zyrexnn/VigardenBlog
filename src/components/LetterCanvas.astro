---
/**
 * LetterCanvas.astro â€” Violet Evergarden themed letter composing interface
 * Features: editable location with presets, export theme, VE ornaments, full translate support
 */
---

<div class="max-w-2xl mx-auto">
  <div
    id="letter-form-container"
    class="relative transition-all duration-700 mt-8"
  >
    <!-- Typewriter Platen (Roller) -->
    <div
      class="h-8 sm:h-10 w-[106%] -ml-[3%] bg-gradient-to-b from-[#1a1a1a] via-[#3d3d3d] to-[#0a0a0a] rounded-full shadow-[0_10px_20px_rgba(0,0,0,0.6)] border-y border-gray-500/40 relative z-20 flex items-center justify-between px-1 sm:px-2"
    >
      <!-- Left Knob -->
      <div
        class="w-5 h-5 sm:w-6 sm:h-6 rounded-full bg-gradient-to-br from-[#cca74e] via-[#8f7533] to-[#3e2b22] border-2 border-black/80 shadow-inner flex items-center justify-center"
      >
        <div class="w-2 h-2 rounded-full bg-black/40"></div>
      </div>
      <!-- Roller highlight / paper feed -->
      <div
        class="flex-1 h-[2px] bg-white/10 mx-4 sm:mx-8 rounded-full shadow-[0_1px_2px_rgba(255,255,255,0.2)]"
      >
      </div>
      <!-- Right Knob -->
      <div
        class="w-5 h-5 sm:w-6 sm:h-6 rounded-full bg-gradient-to-bl from-[#cca74e] via-[#8f7533] to-[#3e2b22] border-2 border-black/80 shadow-inner flex items-center justify-center"
      >
        <div class="w-2 h-2 rounded-full bg-black/40"></div>
      </div>
    </div>

    <!-- Shadow thrown by paper rolling into platen -->
    <div
      class="bg-gradient-to-b from-black/50 to-transparent h-6 w-full absolute top-[1.5rem] z-10 pointer-events-none mx-auto w-[98%] left-[1%]"
    >
    </div>

    <div
      id="letter-paper"
      class="letter-canvas border border-gold/40 dark:border-wood/80 shadow-[0_20px_50px_rgba(0,0,0,0.5)] bg-paper dark:bg-[#1f1612] w-[98%] mx-auto mt-[-1rem] px-6 py-10 sm:px-12 sm:py-16 md:px-14 md:py-20 relative transition-transform duration-75"
    >
      <svg
        class="letter-ornament top-left"
        viewBox="0 0 100 100"
        fill="currentColor"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M5 5 Q5 50 50 50 Q5 50 5 95"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <path
          d="M5 5 Q50 5 50 50 Q50 5 95 5"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <circle cx="5" cy="5" r="3" opacity="0.4"></circle>
        <path
          d="M15 15 Q15 30 30 30"
          stroke="currentColor"
          stroke-width="1"
          fill="none"
          opacity="0.3"></path>
        <circle cx="12" cy="12" r="1.5" opacity="0.3"></circle>
      </svg>
      <svg
        class="letter-ornament top-right"
        viewBox="0 0 100 100"
        fill="currentColor"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M5 5 Q5 50 50 50 Q5 50 5 95"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <path
          d="M5 5 Q50 5 50 50 Q50 5 95 5"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <circle cx="5" cy="5" r="3" opacity="0.4"></circle>
        <path
          d="M15 15 Q15 30 30 30"
          stroke="currentColor"
          stroke-width="1"
          fill="none"
          opacity="0.3"></path>
        <circle cx="12" cy="12" r="1.5" opacity="0.3"></circle>
      </svg>
      <svg
        class="letter-ornament bottom-left"
        viewBox="0 0 100 100"
        fill="currentColor"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M5 5 Q5 50 50 50 Q5 50 5 95"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <path
          d="M5 5 Q50 5 50 50 Q50 5 95 5"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <circle cx="5" cy="5" r="3" opacity="0.4"></circle>
        <path
          d="M15 15 Q15 30 30 30"
          stroke="currentColor"
          stroke-width="1"
          fill="none"
          opacity="0.3"></path>
        <circle cx="12" cy="12" r="1.5" opacity="0.3"></circle>
      </svg>
      <svg
        class="letter-ornament bottom-right"
        viewBox="0 0 100 100"
        fill="currentColor"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M5 5 Q5 50 50 50 Q5 50 5 95"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <path
          d="M5 5 Q50 5 50 50 Q50 5 95 5"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <circle cx="5" cy="5" r="3" opacity="0.4"></circle>
        <path
          d="M15 15 Q15 30 30 30"
          stroke="currentColor"
          stroke-width="1"
          fill="none"
          opacity="0.3"></path>
        <circle cx="12" cy="12" r="1.5" opacity="0.3"></circle>
      </svg>

      <div class="letter-watermark" data-i18n="watermark">
        Auto Memories Doll Service
      </div>

      <div
        class="text-right mb-8 text-xs text-ink/40 dark:text-white/30 italic font-typewriter relative z-10"
      >
        <span id="letter-date"></span><br />
        <span data-i18n="writtenAt">Written at</span>
        <div class="inline-flex items-center gap-1">
          <select
            id="letter-location-select"
            class="location-select bg-transparent border-b border-dashed border-ink/15 dark:border-white/10 text-ink dark:text-white font-typewriter text-xs focus:outline-none focus:border-gold/40 cursor-pointer"
          >
            <option value="Leiden" data-i18n="loc.leiden">Leiden</option>
            <option value="Hodinsara" data-i18n="loc.hodinsara"
              >Hodinsara</option
            >
            <option value="Shahar" data-i18n="loc.shahar">Shahar</option>
            <option value="Ecarte Island" data-i18n="loc.ecarte"
              >Ecarte Island</option
            >
            <option value="Ctrigal" data-i18n="loc.ctrigal">Ctrigal</option>
            <option value="Drossel" data-i18n="loc.drossel">Drossel</option>
            <option value="custom" data-i18n="loc.custom">Custom...</option>
          </select>
          <input
            id="letter-location-custom"
            type="text"
            placeholder="Enter location..."
            maxlength="50"
            class="location-input hidden"
            data-placeholder-jp="å ´æ‰€ã‚’å…¥åŠ›..."
            data-placeholder-id="Ketik lokasi..."
            data-placeholder-en="Enter location..."
          />
        </div>
      </div>

      <div class="mb-6 relative z-10">
        <label
          class="block text-[10px] uppercase tracking-[0.3em] text-gold/60 font-sans font-bold mb-2"
          data-i18n="letterTo"
        >
          To (Optional)
        </label>
        <input
          id="letter-recipient"
          type="text"
          placeholder="Recipient Name..."
          data-placeholder-jp="å—å–äººã®åå‰..."
          data-placeholder-id="Nama Penerima..."
          data-placeholder-en="Recipient Name..."
          maxlength="100"
          class="w-full bg-transparent border-b border-dashed border-ink/15 dark:border-white/10
                 text-ink dark:text-white font-typewriter text-lg py-2 px-1
                 placeholder:text-ink/20 dark:placeholder:text-white/15
                 focus:outline-none focus:border-gold/40 transition-colors"
        />
      </div>

      <div class="mb-6 relative z-10">
        <label
          class="block text-[10px] uppercase tracking-[0.3em] text-gold/60 font-sans font-bold mb-3"
          data-i18n="letterContent"
        >
          Letter Content
        </label>
        <textarea
          id="letter-content"
          rows="12"
          placeholder="Start writing your letter here... (Minimum 50 characters)"
          data-placeholder-jp="ã“ã“ã«æ‰‹ç´™ã‚’æ›¸ãå§‹ã‚ã¦ãã ã•ã„â€¦ï¼ˆæœ€ä½50æ–‡å­—ï¼‰"
          data-placeholder-id="Mulai menulis surat Anda di sini... (Minimal 50 karakter)"
          data-placeholder-en="Start writing your letter here... (Minimum 50 characters)"
          class="w-full bg-transparent resize-none
                 text-ink/90 dark:text-white/80 font-typewriter text-base sm:text-lg leading-[32px]
                 placeholder:text-ink/20 dark:placeholder:text-white/15
                 focus:outline-none p-0 border-none"
          style="line-height: 32px;"></textarea>
      </div>

      <div class="flex items-center justify-between mb-8 relative z-10">
        <div class="flex items-center gap-2">
          <span
            id="char-count"
            class="text-xs font-sans font-bold text-red-500/80">0</span
          >
          <span class="text-[10px] text-ink/30 dark:text-white/20 font-sans"
            >/50 <span data-i18n="minChars">min</span></span
          >
        </div>
        <div
          id="char-status"
          class="text-[10px] font-sans italic text-red-500/60"
          data-i18n="tooShort"
        >
          Too short â€” write from the heart â™¡
        </div>
      </div>

      <div class="mb-8 relative z-10">
        <label
          class="block text-[10px] uppercase tracking-[0.3em] text-gold/60 font-sans font-bold mb-3"
          data-i18n="exportTheme"
        >
          Export Theme
        </label>
        <div class="grid grid-cols-2 gap-3" id="export-theme-grid">
          <button
            type="button"
            class="theme-toggle-btn active"
            data-export-theme="parchment"
          >
            <span class="text-lg">â˜€ï¸</span>
            <div class="text-left">
              <div data-i18n="theme.parchment">Parchment</div>
              <div
                class="text-[8px] opacity-50 normal-case tracking-normal mt-0.5"
                data-i18n="theme.parchmentDesc"
              >
                Classic warm beige
              </div>
            </div>
          </button>
          <button
            type="button"
            class="theme-toggle-btn"
            data-export-theme="midnight"
          >
            <span class="text-lg">ğŸŒ™</span>
            <div class="text-left">
              <div data-i18n="theme.midnight">Midnight</div>
              <div
                class="text-[8px] opacity-50 normal-case tracking-normal mt-0.5"
                data-i18n="theme.midnightDesc"
              >
                Elegant dark navy
              </div>
            </div>
          </button>
        </div>
      </div>

      <div class="mb-8 relative z-10">
        <label
          class="block text-[10px] uppercase tracking-[0.3em] text-gold/60 font-sans font-bold mb-3"
          data-i18n="selectStamp"
        >
          Select Stamp
        </label>
        <div class="grid grid-cols-3 sm:grid-cols-6 gap-3" id="stamp-grid">
          <button type="button" class="stamp-option active" data-stamp="postal">
            <div class="stamp-card">
              <span class="text-2xl">ğŸ“®</span>
              <span class="stamp-label" data-i18n="stamp.postal">Postal</span>
            </div>
          </button>
          <button type="button" class="stamp-option" data-stamp="flower">
            <div class="stamp-card">
              <span class="text-2xl">ğŸŒ¸</span>
              <span class="stamp-label" data-i18n="stamp.sakura">Sakura</span>
            </div>
          </button>
          <button type="button" class="stamp-option" data-stamp="brooch">
            <div class="stamp-card">
              <span class="text-2xl">ğŸ’</span>
              <span class="stamp-label" data-i18n="stamp.brooch">Brooch</span>
            </div>
          </button>
          <button type="button" class="stamp-option" data-stamp="quill">
            <div class="stamp-card">
              <span class="text-2xl">ğŸª¶</span>
              <span class="stamp-label" data-i18n="stamp.quill">Quill</span>
            </div>
          </button>
          <button type="button" class="stamp-option" data-stamp="letter">
            <div class="stamp-card">
              <span class="text-2xl">âœ‰ï¸</span>
              <span class="stamp-label" data-i18n="stamp.letter">Letter</span>
            </div>
          </button>
          <button type="button" class="stamp-option" data-stamp="tulip">
            <div class="stamp-card">
              <span class="text-2xl">ğŸŒ·</span>
              <span class="stamp-label" data-i18n="stamp.tulip">Tulip</span>
            </div>
          </button>
        </div>
      </div>

      <div class="mb-10 relative z-10">
        <label
          class="block text-[10px] uppercase tracking-[0.3em] text-gold/60 font-sans font-bold mb-2"
          data-i18n="letterFrom"
        >
          From (Optional)
        </label>
        <input
          id="letter-sender"
          type="text"
          placeholder="Your Alias..."
          data-placeholder-jp="ã‚ãªãŸã®åå‰..."
          data-placeholder-id="Alias Anda..."
          data-placeholder-en="Your Alias..."
          maxlength="60"
          class="w-full bg-transparent border-b border-dashed border-ink/15 dark:border-white/10
                 text-ink dark:text-white font-typewriter text-lg py-2 px-1
                 placeholder:text-ink/20 dark:placeholder:text-white/15
                 focus:outline-none focus:border-gold/40 transition-colors"
        />
      </div>

      <div
        class="flex flex-col items-center gap-4 pt-6 border-t border-dashed border-ink/10 dark:border-white/10 relative z-10"
      >
        <p
          class="text-[10px] text-ink/30 dark:text-white/20 font-sans uppercase tracking-[0.2em]"
          data-i18n="sealAndSend"
        >
          Seal & Send
        </p>
        <button
          id="wax-seal-submit"
          type="button"
          class="wax-seal-btn group"
          disabled
          data-i18n-title="sealTitle"
          title="Seal Letter"
        >
          <span
            class="text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)] font-heading italic font-bold"
            >V</span
          >
        </button>
        <p
          id="seal-hint"
          class="text-[9px] text-ink/40 dark:text-white/30 font-sans italic"
          data-i18n="sealHintLocked"
        >
          Write at least 50 characters to unlock the seal
        </p>
      </div>
      <!-- Typewriter Hammer Overlay (Visual Fake) -->
      <div
        id="hammer-container"
        class="absolute top-[30%] left-1/2 -translate-x-1/2 pointer-events-none opacity-0 drop-shadow-2xl z-[100] origin-top"
      >
        <div
          class="w-1.5 h-32 bg-gradient-to-b from-gray-400 to-gray-800 mx-auto rounded-b-sm border-x border-gray-600"
        >
        </div>
        <div
          class="w-6 h-8 bg-gradient-to-br from-gray-300 via-gray-500 to-gray-700 rounded-sm shadow-xl flex items-center justify-center -mt-2 border-b-2 border-gray-900"
        >
          <div
            class="text-[12px] font-typewriter text-black/60 font-bold scale-y-[-1] scale-x-[-1]"
          >
            V
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div
  id="export-preview-wrapper"
  class="fixed -left-[9999px] top-0 pointer-events-none"
  aria-hidden="true"
>
  <div
    id="export-preview"
    class="w-[600px]"
    style="font-family: 'Special Elite', 'Courier Prime', monospace;"
  >
    <div
      id="ep-bg"
      style="padding: 48px; position: relative; border-radius: 4px;"
    >
      <svg
        id="ep-ornament-tl"
        style="position: absolute; top: 10px; left: 10px; width: 40px; height: 40px; opacity: 0.12;"
        viewBox="0 0 100 100"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M5 5 Q5 50 50 50 Q5 50 5 95"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <path
          d="M5 5 Q50 5 50 50 Q50 5 95 5"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <circle cx="5" cy="5" r="3" opacity="0.4"></circle>
      </svg>
      <svg
        id="ep-ornament-tr"
        style="position: absolute; top: 10px; right: 10px; width: 40px; height: 40px; opacity: 0.12; transform: scaleX(-1);"
        viewBox="0 0 100 100"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M5 5 Q5 50 50 50 Q5 50 5 95"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <path
          d="M5 5 Q50 5 50 50 Q50 5 95 5"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <circle cx="5" cy="5" r="3" opacity="0.4"></circle>
      </svg>
      <svg
        id="ep-ornament-bl"
        style="position: absolute; bottom: 10px; left: 10px; width: 40px; height: 40px; opacity: 0.12; transform: scaleY(-1);"
        viewBox="0 0 100 100"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M5 5 Q5 50 50 50 Q5 50 5 95"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <path
          d="M5 5 Q50 5 50 50 Q50 5 95 5"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <circle cx="5" cy="5" r="3" opacity="0.4"></circle>
      </svg>
      <svg
        id="ep-ornament-br"
        style="position: absolute; bottom: 10px; right: 10px; width: 40px; height: 40px; opacity: 0.12; transform: scale(-1);"
        viewBox="0 0 100 100"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M5 5 Q5 50 50 50 Q5 50 5 95"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <path
          d="M5 5 Q50 5 50 50 Q50 5 95 5"
          stroke="currentColor"
          stroke-width="2"
          fill="none"
          opacity="0.6"></path>
        <circle cx="5" cy="5" r="3" opacity="0.4"></circle>
      </svg>

      <div
        id="ep-date"
        style="text-align: right; font-size: 11px; font-style: italic; margin-bottom: 32px;"
      >
      </div>
      <div
        id="ep-salutation"
        style="font-family: 'Playfair Display', serif; font-size: 18px; margin-bottom: 24px;"
      >
      </div>
      <div
        id="ep-content"
        style="font-size: 15px; line-height: 2; white-space: pre-wrap; margin-bottom: 40px;"
      >
      </div>
      <div style="text-align: right;">
        <div
          id="ep-sincerely"
          style="font-style: italic; font-size: 11px; margin-bottom: 8px;"
        >
          Sincerely,
        </div>
        <div
          id="ep-sender"
          style="font-family: 'Playfair Display', serif; font-size: 22px; font-style: italic;"
        >
        </div>
        <div
          id="ep-service"
          style="font-family: 'Inter', sans-serif; font-size: 8px; text-transform: uppercase; letter-spacing: 0.3em; margin-top: 8px;"
        >
          Auto Memories Doll Service
        </div>
      </div>
      <div
        id="ep-stamp"
        style="position: absolute; top: 16px; right: 16px; font-size: 28px;"
      >
      </div>
      <div
        id="ep-airmail-top"
        style="position: absolute; top: 0; left: 0; right: 0; height: 6px; border-radius: 4px 4px 0 0;"
      >
      </div>
      <div
        id="ep-airmail-bottom"
        style="position: absolute; bottom: 0; left: 0; right: 0; height: 6px; border-radius: 0 0 4px 4px;"
      >
      </div>
    </div>
  </div>
</div>

<div id="petal-overlay" class="petal-overlay hidden">
  <div
    class="absolute inset-0 bg-paper/60 dark:bg-dark-bg/70 flex items-center justify-center"
  >
    <div
      id="overlay-message"
      class="text-center space-y-4 animate-letter-fadein"
    >
      <div class="text-4xl">âœ‰ï¸</div>
      <p
        class="font-heading text-lg text-ink/80 dark:text-white/80"
        data-i18n="sendingLetter"
      >
        Sending your letter...
      </p>
      <p class="text-xs text-ink/40 dark:text-white/30 italic font-typewriter">
        Auto Memories Doll Service
      </p>
    </div>
  </div>
</div>

<div
  id="letter-toast"
  class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[200] opacity-0 translate-y-4
         transition-all duration-500 pointer-events-none"
>
  <div
    class="bg-ink/90 dark:bg-white/90 text-white dark:text-ink rounded-xl px-6 py-4 shadow-2xl
              flex items-center gap-3 max-w-md backdrop-blur-sm"
  >
    <span class="text-xl">ğŸ“œ</span>
    <div>
      <p id="toast-title" class="text-sm font-bold font-heading"></p>
      <p id="toast-desc" class="text-xs opacity-70 font-body mt-0.5"></p>
    </div>
  </div>
</div>

<style>
  .stamp-option {
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .stamp-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.4rem;
    padding: 0.75rem 0.5rem;
    border-radius: 0.5rem;
    border: 2px solid transparent;
    background: rgba(0, 0, 0, 0.02);
    transition: all 0.3s ease;
  }
  :global(.dark) .stamp-card {
    background: rgba(255, 255, 255, 0.03);
  }
  .stamp-option:hover .stamp-card {
    border-color: rgba(197, 160, 89, 0.3);
    background: rgba(197, 160, 89, 0.05);
  }
  .stamp-option.active .stamp-card {
    border-color: rgba(197, 160, 89, 0.6);
    background: rgba(197, 160, 89, 0.08);
    box-shadow: 0 0 15px rgba(197, 160, 89, 0.1);
  }
  .stamp-label {
    font-size: 0.6rem;
    font-family: "Inter", sans-serif;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: rgba(45, 45, 45, 0.5);
  }
  :global(.dark) .stamp-label {
    color: rgba(255, 255, 255, 0.35);
  }

  .location-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%238B7355' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0 center;
    padding-right: 14px;
  }
  :global(.dark) .location-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23C5A059' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  }
  .location-select option {
    background: #f5f0e1;
    color: #2d2d2d;
  }
  :global(.dark) .location-select option {
    background: #1a1e2e;
    color: #fff;
  }

  @keyframes selfDestruct {
    0% {
      opacity: 1;
      transform: scale(1) rotate(0deg);
      filter: blur(0px);
    }
    30% {
      opacity: 0.8;
      transform: scale(0.97) rotate(-0.5deg);
      filter: blur(1px);
    }
    60% {
      opacity: 0.4;
      transform: scale(0.92) rotate(0.5deg) translateY(-10px);
      filter: blur(3px);
    }
    100% {
      opacity: 0;
      transform: scale(0.85) rotate(-1deg) translateY(-30px);
      filter: blur(8px);
    }
  }
  .self-destructing {
    animation: selfDestruct 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    pointer-events: none;
  }

  @keyframes type-strike {
    0% {
      transform: translateY(0) scale(1);
      filter: contrast(1);
    }
    50% {
      transform: translateY(1px) scale(0.999);
      filter: contrast(1.05);
    }
    100% {
      transform: translateY(0) scale(1);
      filter: contrast(1);
    }
  }
  .typing-strike {
    animation: type-strike 0.1s ease-out;
  }

  @keyframes hammer-strike {
    0% {
      transform: translate(-50%, -40px) rotateX(70deg);
      opacity: 0;
    }
    50% {
      transform: translate(-50%, 0px) rotateX(0deg);
      opacity: 1;
    }
    100% {
      transform: translate(-50%, -40px) rotateX(70deg);
      opacity: 0;
    }
  }
  .animate-strike {
    animation: hammer-strike 0.15s cubic-bezier(0.2, 0.8, 0.2, 1);
  }
</style>

<script>
  document.addEventListener("astro:page-load", () => {
    const textarea = document.getElementById(
      "letter-content",
    ) as HTMLTextAreaElement;
    const charCount = document.getElementById("char-count");
    const charStatus = document.getElementById("char-status");
    const sealBtn = document.getElementById(
      "wax-seal-submit",
    ) as HTMLButtonElement;
    const sealHint = document.getElementById("seal-hint");
    const recipientInput = document.getElementById(
      "letter-recipient",
    ) as HTMLInputElement;
    const senderInput = document.getElementById(
      "letter-sender",
    ) as HTMLInputElement;
    const locationSelect = document.getElementById(
      "letter-location-select",
    ) as HTMLSelectElement;
    const locationCustom = document.getElementById(
      "letter-location-custom",
    ) as HTMLInputElement;
    const stampGrid = document.getElementById("stamp-grid");
    const exportThemeGrid = document.getElementById("export-theme-grid");
    const petalOverlay = document.getElementById("petal-overlay");
    const dateEl = document.getElementById("letter-date");
    const formContainer = document.getElementById("letter-form-container");
    const toast = document.getElementById("letter-toast");
    const toastTitle = document.getElementById("toast-title");
    const toastDesc = document.getElementById("toast-desc");

    if (!textarea || !sealBtn) return;

    if (dateEl) {
      dateEl.textContent = new Date().toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
      });
    }

    let selectedExportTheme = "parchment";

    const i18nStrings: Record<string, Record<string, string>> = {
      tooShort: {
        en: "Too short â€” write from the heart â™¡",
        ja: "çŸ­ã™ãã¾ã™ â€” å¿ƒã‚’è¾¼ã‚ã¦æ›¸ã„ã¦ â™¡",
        id: "Terlalu pendek â€” tulis dari hati â™¡",
      },
      readyToSeal: {
        en: "Ready to seal âœ¦",
        ja: "å°è‹ã®æº–å‚™å®Œäº† âœ¦",
        id: "Siap disegel âœ¦",
      },
      sealHintLocked: {
        en: "Write at least 50 characters to unlock the seal",
        ja: "å°è‹ã‚’è§£ãã«ã¯50æ–‡å­—ä»¥ä¸Šæ›¸ã„ã¦ãã ã•ã„",
        id: "Tulis minimal 50 karakter untuk membuka segel",
      },
      sealHintReady: {
        en: "Click the seal to send your letter",
        ja: "å°è‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ‰‹ç´™ã‚’é€ã£ã¦ãã ã•ã„",
        id: "Klik segel untuk mengirim surat",
      },
      toastTitle: {
        en: "Letter Immortalized",
        ja: "æ‰‹ç´™ã¯æ°¸é ã«",
        id: "Surat Telah Diabadikan",
      },
      toastDesc: {
        en: "Your letter has been saved as an image and erased from our system.",
        ja: "æ‰‹ç´™ã¯ç”»åƒã¨ã—ã¦ä¿å­˜ã•ã‚Œã€ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰æ¶ˆå»ã•ã‚Œã¾ã—ãŸã€‚",
        id: "Surat Anda telah diabadikan dan dihapus dari sistem kami.",
      },
      exportFail: {
        en: "Export failed. Please try again.",
        ja: "Exportã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
        id: "Export gagal. Silakan coba lagi.",
      },
      sincerely: {
        en: "Sincerely,",
        ja: "æ•¬å…·,",
        id: "Dengan hormat,",
      },
      dearest: {
        en: "Dearest",
        ja: "è¦ªæ„›ãªã‚‹",
        id: "Untuk yang tercinta",
      },
      dearReader: {
        en: "Dear Reader,",
        ja: "æ‹å•“ã€",
        id: "Kepada pembaca,",
      },
      writtenAt: {
        en: "Written at",
        ja: "åŸ·ç­†å ´æ‰€",
        id: "Ditulis di",
      },
    };

    const langMap: Record<string, string> = { JP: "ja", ID: "id", EN: "en" };
    function getLang(): string {
      return langMap[localStorage.getItem("vigarden-lang") || "ID"] || "id";
    }
    function t(key: string): string {
      return i18nStrings[key]?.[getLang()] || i18nStrings[key]?.["en"] || "";
    }

    function updatePlaceholders() {
      const lang = getLang();
      document
        .querySelectorAll<
          HTMLInputElement | HTMLTextAreaElement
        >("[data-placeholder-" + lang + "]")
        .forEach((el) => {
          const val = el.getAttribute("data-placeholder-" + lang);
          if (val) el.placeholder = val;
        });
    }
    updatePlaceholders();

    function updateI18nElements() {
      const lang = getLang();
      document.querySelectorAll<HTMLElement>("[data-i18n]").forEach((el) => {
        const key = el.getAttribute("data-i18n");
        if (!key) return;
        const val = el.getAttribute("data-" + lang);
        if (val) el.textContent = val;
      });
    }

    locationSelect?.addEventListener("change", () => {
      if (locationSelect.value === "custom") {
        locationCustom?.classList.remove("hidden");
        locationCustom?.focus();
      } else {
        locationCustom?.classList.add("hidden");
        locationCustom.value = "";
      }
    });

    function getLocation(): string {
      if (locationSelect?.value === "custom") {
        return locationCustom?.value.trim() || "Leiden";
      }
      return locationSelect?.value || "Leiden";
    }

    let audioCtx: AudioContext | null = null;
    let audioBuffer: AudioBuffer | null = null;

    async function initAudio() {
      if (audioCtx) return;
      try {
        audioCtx = new AudioContext();
        const resp = await fetch("/audio/mesinketik.mp3");
        const arrayBuffer = await resp.arrayBuffer();
        audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
      } catch (e) {
        console.warn("Audio init failed:", e);
      }
    }

    function playKeystroke() {
      // Audio
      if (audioCtx && audioBuffer) {
        try {
          const source = audioCtx.createBufferSource();
          source.buffer = audioBuffer;
          const offset =
            Math.random() *
            Math.max(0, (audioBuffer as AudioBuffer).duration - 0.15);
          const gain = audioCtx.createGain();
          gain.gain.value = 0.3 + Math.random() * 0.2;
          source.connect(gain);
          gain.connect(audioCtx.destination);
          source.start(0, offset, 0.1 + Math.random() * 0.05);
        } catch (e) {}
      }

      // Micro animations
      const paper = document.getElementById("letter-paper");
      if (paper) {
        paper.classList.remove("typing-strike");
        void paper.offsetWidth;
        paper.classList.add("typing-strike");
      }

      const hammer = document.getElementById("hammer-container");
      if (hammer) {
        hammer.classList.remove("animate-strike");
        void hammer.offsetWidth;
        hammer.classList.add("animate-strike");
      }
    }

    textarea.addEventListener("focus", initAudio, { once: true });

    textarea.addEventListener("input", () => {
      const len = textarea.value.length;
      if (charCount) charCount.textContent = String(len);

      if (len >= 50) {
        if (charCount)
          charCount.className = "text-xs font-sans font-bold text-accent/80";
        if (charStatus) {
          charStatus.textContent = t("readyToSeal");
          charStatus.className = "text-[10px] font-sans italic text-accent/60";
        }
        sealBtn.disabled = false;
        if (sealHint) sealHint.textContent = t("sealHintReady");
      } else {
        if (charCount)
          charCount.className = "text-xs font-sans font-bold text-red-500/80";
        if (charStatus) {
          charStatus.textContent = t("tooShort");
          charStatus.className = "text-[10px] font-sans italic text-red-500/60";
        }
        sealBtn.disabled = true;
        if (sealHint) sealHint.textContent = t("sealHintLocked");
      }

      playKeystroke();
    });

    let selectedStamp = "postal";
    stampGrid?.addEventListener("click", (e) => {
      const btn = (e.target as HTMLElement).closest(
        ".stamp-option",
      ) as HTMLElement;
      if (!btn) return;
      stampGrid
        .querySelectorAll(".stamp-option")
        .forEach((el) => el.classList.remove("active"));
      btn.classList.add("active");
      selectedStamp = btn.dataset.stamp || "postal";
    });

    exportThemeGrid?.addEventListener("click", (e) => {
      const btn = (e.target as HTMLElement).closest(
        ".theme-toggle-btn",
      ) as HTMLElement;
      if (!btn) return;
      exportThemeGrid
        .querySelectorAll(".theme-toggle-btn")
        .forEach((el) => el.classList.remove("active"));
      btn.classList.add("active");
      selectedExportTheme = btn.dataset.exportTheme || "parchment";
    });

    function sanitize(str: string): string {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    function showPetals() {
      if (!petalOverlay) return;
      petalOverlay.classList.remove("hidden");
      for (let i = 0; i < 12; i++) {
        const petal = document.createElement("div");
        petal.classList.add("petal");
        petal.style.left = `${Math.random() * 100}%`;
        petal.style.animationDuration = `${2.5 + Math.random() * 3}s`;
        petal.style.animationDelay = `${Math.random() * 2}s`;
        petal.style.transform = `scale(${0.5 + Math.random() * 0.8})`;
        petalOverlay.appendChild(petal);
      }
    }

    function hidePetals() {
      if (!petalOverlay) return;
      petalOverlay.classList.add("hidden");
      petalOverlay.querySelectorAll(".petal").forEach((p) => p.remove());
    }

    function showToast() {
      if (!toast || !toastTitle || !toastDesc) return;
      toastTitle.textContent = t("toastTitle");
      toastDesc.textContent = t("toastDesc");
      toast.classList.remove("opacity-0", "translate-y-4");
      toast.classList.add("opacity-100", "translate-y-0");
      setTimeout(() => {
        toast.classList.add("opacity-0", "translate-y-4");
        toast.classList.remove("opacity-100", "translate-y-0");
      }, 6000);
    }

    const exportThemes = {
      parchment: {
        bg: "linear-gradient(145deg, #f5f0e1 0%, #ede4cc 100%)",
        bgColor: "#f5f0e1",
        textColor: "rgba(45,45,45,0.85)",
        dateColor: "rgba(45,45,45,0.4)",
        senderColor: "#00563B",
        serviceColor: "rgba(45,45,45,0.25)",
        sincerelyColor: "rgba(45,45,45,0.5)",
        salutationColor: "#2D2D2D",
        ornamentColor: "#8B7355",
        airmailBg:
          "repeating-linear-gradient(-45deg, transparent, transparent 8px, #c0392b 8px, #c0392b 10px, transparent 10px, transparent 18px, #2c3e50 18px, #2c3e50 20px)",
      },
      midnight: {
        bg: "linear-gradient(145deg, #0f1729 0%, #1a2540 100%)",
        bgColor: "#0f1729",
        textColor: "rgba(255,255,255,0.75)",
        dateColor: "rgba(255,255,255,0.35)",
        senderColor: "#C5A059",
        serviceColor: "rgba(255,255,255,0.2)",
        sincerelyColor: "rgba(255,255,255,0.4)",
        salutationColor: "rgba(255,255,255,0.9)",
        ornamentColor: "#C5A059",
        airmailBg:
          "repeating-linear-gradient(-45deg, transparent, transparent 8px, #8b4513 8px, #8b4513 10px, transparent 10px, transparent 18px, #c5a059 18px, #c5a059 20px)",
      },
    };

    function populatePreview(
      content: string,
      recipient: string,
      sender: string,
    ) {
      const stampIcons: Record<string, string> = {
        postal: "ğŸ“®",
        flower: "ğŸŒ¸",
        brooch: "ğŸ’",
        quill: "ğŸª¶",
        letter: "âœ‰ï¸",
        tulip: "ğŸŒ·",
      };

      const theme =
        exportThemes[selectedExportTheme as keyof typeof exportThemes] ||
        exportThemes.parchment;
      const location = getLocation();

      const epBg = document.getElementById("ep-bg");
      const epDate = document.getElementById("ep-date");
      const epSalutation = document.getElementById("ep-salutation");
      const epContent = document.getElementById("ep-content");
      const epSender = document.getElementById("ep-sender");
      const epStamp = document.getElementById("ep-stamp");
      const epSincerely = document.getElementById("ep-sincerely");
      const epService = document.getElementById("ep-service");
      const epAirmailTop = document.getElementById("ep-airmail-top");
      const epAirmailBottom = document.getElementById("ep-airmail-bottom");

      if (epBg) epBg.style.background = theme.bg;
      if (epAirmailTop) epAirmailTop.style.backgroundImage = theme.airmailBg;
      if (epAirmailBottom)
        epAirmailBottom.style.backgroundImage = theme.airmailBg;

      [
        "ep-ornament-tl",
        "ep-ornament-tr",
        "ep-ornament-bl",
        "ep-ornament-br",
      ].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.style.color = theme.ornamentColor;
      });

      const dateStr = new Date().toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
      });

      if (epDate) {
        epDate.textContent = dateStr + "\n" + t("writtenAt") + " " + location;
        epDate.style.color = theme.dateColor;
      }
      if (epSalutation) {
        epSalutation.textContent = recipient
          ? `${t("dearest")} ${recipient},`
          : t("dearReader");
        epSalutation.style.color = theme.salutationColor;
      }
      if (epContent) {
        epContent.textContent = content;
        epContent.style.color = theme.textColor;
      }
      if (epSincerely) {
        epSincerely.textContent = t("sincerely");
        epSincerely.style.color = theme.sincerelyColor;
      }
      if (epSender) {
        epSender.textContent = sender || "Anonymous";
        epSender.style.color = theme.senderColor;
      }
      if (epService) {
        epService.style.color = theme.serviceColor;
      }
      if (epStamp) epStamp.textContent = stampIcons[selectedStamp] || "ğŸ“®";
    }

    function resetForm() {
      textarea.value = "";
      if (recipientInput) recipientInput.value = "";
      if (senderInput) senderInput.value = "";
      if (locationSelect) locationSelect.value = "Leiden";
      if (locationCustom) {
        locationCustom.value = "";
        locationCustom.classList.add("hidden");
      }
      if (charCount) {
        charCount.textContent = "0";
        charCount.className = "text-xs font-sans font-bold text-red-500/80";
      }
      if (charStatus) {
        charStatus.textContent = t("tooShort");
        charStatus.className = "text-[10px] font-sans italic text-red-500/60";
      }
      sealBtn.disabled = true;
      if (sealHint) sealHint.textContent = t("sealHintLocked");
      stampGrid?.querySelectorAll(".stamp-option").forEach((el, i) => {
        if (i === 0) el.classList.add("active");
        else el.classList.remove("active");
      });
      selectedStamp = "postal";
      exportThemeGrid
        ?.querySelectorAll(".theme-toggle-btn")
        .forEach((el, i) => {
          if (i === 0) el.classList.add("active");
          else el.classList.remove("active");
        });
      selectedExportTheme = "parchment";
    }

    sealBtn.addEventListener("click", async () => {
      const content = textarea.value.trim();
      if (content.length < 50) return;

      const recipient = sanitize(recipientInput?.value.trim() || "");
      const sender = sanitize(senderInput?.value.trim() || "Anonymous");

      sealBtn.classList.add("stamped");
      showPetals();
      populatePreview(content, recipient, sender);
      await new Promise((r) => setTimeout(r, 1500));

      try {
        const { toPng } =
          await import("https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/+esm");
        const preview = document.getElementById("export-preview");
        if (!preview) throw new Error("Preview element not found");

        const theme =
          exportThemes[selectedExportTheme as keyof typeof exportThemes] ||
          exportThemes.parchment;

        const dataUrl = await toPng(preview, {
          backgroundColor: theme.bgColor,
          pixelRatio: 2,
        });

        const link = document.createElement("a");
        link.download = `letter-${Date.now().toString(36)}.png`;
        link.href = dataUrl;
        link.click();
      } catch (e) {
        console.error("Export failed:", e);
        alert(t("exportFail"));
        hidePetals();
        sealBtn.classList.remove("stamped");
        return;
      }

      hidePetals();

      if (formContainer) {
        formContainer.classList.add("self-destructing");
      }

      setTimeout(() => {
        showToast();
        if (formContainer) {
          formContainer.classList.remove("self-destructing");
          formContainer.style.opacity = "0";
          setTimeout(() => {
            resetForm();
            formContainer.style.transition = "opacity 0.8s ease";
            formContainer.style.opacity = "1";
          }, 400);
        }
        localStorage.removeItem("vigarden-unsent-letters");
      }, 1800);
    });

    sealBtn.addEventListener("animationend", () => {
      sealBtn.classList.remove("stamped");
    });
  });
</script>
